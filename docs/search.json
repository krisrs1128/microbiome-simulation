[{"path":"index.html","id":"introduction","chapter":"1 Introduction","heading":"1 Introduction","text":"website accompanies review\nSemisynthetic Simulation Microbiome Analysis. examples discussed \ncase studies can reproduced running code , \nalso included additional introductory material packages simplify\nanalysis.","code":""},{"path":"index.html","id":"setup","chapter":"1 Introduction","heading":"1.1 Setup","text":"MIGsim package provides wrapper functions use\nthroughout book. can install running:block loads packages used book.","code":"\ndevtools::install_github(\"krisrs1128/intro-to-simulation/MIGsim\")\nsuppressPackageStartupMessages({\n  library(CovTools)\n  library(SpiecEasi)\n  library(SummarizedExperiment)\n  library(dplyr)\n  library(forcats)\n  library(gamboostLSS)\n  library(ggdist)\n  library(ggplot2)\n  library(glue)\n  library(mixOmics)\n  library(mutoss)\n  library(patchwork)\n  library(pwr)\n  library(scico)\n  library(splines)\n  library(tibble)\n  library(tidyr)\n  library(MIGsim)\n  library(purrr)\n  library(scDesigner)\n  library(gamlss)\n  library(mia)\n  library(wesanderson)\n  library(SimBench)\n  library(tidySummarizedExperiment)\n  library(ks)\n  library(stringr)\n  library(ANCOMBC)\n  library(edgeR)\n  library(ggrepel)\n  library(ggpubr)\n})\ntheme_set(theme_classic() + theme(rect = element_rect(fill = \"transparent\")))"},{"path":"index.html","id":"using-summarizedexperiment","chapter":"1 Introduction","heading":"1.2 Using SummarizedExperiment","text":"SummarizedExperiment data structures simplify manipulation sequencing\nexperiments, ’ll using throughout tutorials. example,\ndistinguish molecule counts, stored assay slot,\nsample descriptors, stored colData. time, \nseparate components nicely synchronized. example, subsetting samples\none tables automatically subsets .line loads small subset genera \nAtlas experiment, \nprofiled gut microbiomes 1006 healthy adults Western Europe.Exercise: practice working SummarizedExperiment\nobjects, try answering:many genera available experiment object?common phylum dataset?average participant age?average abundance Allistipes et rel. among people obese BMI group?Hint: important functions assay(), rowData(), colData().Solution","code":"\ndata(atlas)\ntable(rowData(atlas)$Phylum)## \n## Actinobacteria  Bacteroidetes     Firmicutes \n##              1              2             21\nmean(atlas$age)## [1] 45.15629\nix <- colData(atlas)$bmi_group == \"obese\"\nabundances <- assay(atlas)\nrowMeans(abundances[, ix])##                   Allistipes et rel.          Anaerostipes caccae et rel.         Bacteroides vulgatus et rel.                      Bifidobacterium     Bryantella formatexigens et rel. \n##                            289.85263                            123.84211                           1235.44211                            120.72982                            137.74737 \n##       Butyrivibrio crossotus et rel.        Clostridium cellulosi et rel.           Clostridium leptum et rel.           Clostridium nexile et rel.     Clostridium orbiscindens et rel. \n##                            188.54035                            437.13684                            129.88070                             73.69474                            231.82807 \n##       Clostridium sphenoides et rel.        Clostridium symbiosum et rel.         Coprococcus eutactus et rel.        Dorea formicigenerans et rel.    Lachnospira pectinoschiza et rel. \n##                            139.35439                            331.90175                            222.15088                            176.07368                            127.75439 \n##   Oscillospira guillermondii et rel. Outgrouping clostridium cluster XIVa          Ruminococcus bromii et rel.        Ruminococcus callidus et rel.           Ruminococcus obeum et rel. \n##                           1560.27368                             91.93684                            100.09123                            103.61754                            449.28421 \n##       Sporobacter termitidis et rel.     Subdoligranulum variable at rel.           Uncultured Clostridiales I          Uncultured Clostridiales II \n##                            423.71579                            442.34737                            191.28772                            152.83509\nnrow(atlas)## [1] 24\ntable(rowData(atlas)$Phylum)## \n## Actinobacteria  Bacteroidetes     Firmicutes \n##              1              2             21\nmean(atlas$age)## [1] 45.15629\natlas[, atlas$bmi_group == \"obese\"] |>\n  assay() |>\n  rowMeans()##                   Allistipes et rel.          Anaerostipes caccae et rel.         Bacteroides vulgatus et rel.                      Bifidobacterium     Bryantella formatexigens et rel. \n##                            289.85263                            123.84211                           1235.44211                            120.72982                            137.74737 \n##       Butyrivibrio crossotus et rel.        Clostridium cellulosi et rel.           Clostridium leptum et rel.           Clostridium nexile et rel.     Clostridium orbiscindens et rel. \n##                            188.54035                            437.13684                            129.88070                             73.69474                            231.82807 \n##       Clostridium sphenoides et rel.        Clostridium symbiosum et rel.         Coprococcus eutactus et rel.        Dorea formicigenerans et rel.    Lachnospira pectinoschiza et rel. \n##                            139.35439                            331.90175                            222.15088                            176.07368                            127.75439 \n##   Oscillospira guillermondii et rel. Outgrouping clostridium cluster XIVa          Ruminococcus bromii et rel.        Ruminococcus callidus et rel.           Ruminococcus obeum et rel. \n##                           1560.27368                             91.93684                            100.09123                            103.61754                            449.28421 \n##       Sporobacter termitidis et rel.     Subdoligranulum variable at rel.           Uncultured Clostridiales I          Uncultured Clostridiales II \n##                            423.71579                            442.34737                            191.28772                            152.83509"},{"path":"index.html","id":"warm-up-a-gaussian-example","chapter":"1 Introduction","heading":"1.3 Warm-up: A Gaussian Example","text":"’s toy dataset illustrate main idea GAMLSS. panel \nplot represents different feature (e.g., taxon, gene, metabolite…).\nabundance varies smoothly time, first three panels, \ntrends differ group assignment.can try approximate data new simulator. setup_simulator\ncommand takes template SummarizedExperiment object first argument.\nsecond gives R formula syntax-style specification GAMLSS parameters\n(mean SD, case) dependence sample properties. last argument\ngives type model fit, case, Gaussian location-shape-scale\nmodel.Exercise: Right now, panel allows interaction trend \ngroup type. Can define simulator groups effect \ntrends first two panels? basis defining synthetic\nnegative controls.Solution: can modify formula longer interaction\ngroup. just need remove * group original formula updated\nlink function. ensure applies first two panels, use\n1:2 first argument mutate. first argument specifies \nfeatures apply new formula .","code":"\ndata(exper_ts)\nexper_lineplot(exper_ts)## Warning: Removed 12 rows containing missing values or values outside the scale range (`geom_point()`).\nsim <- setup_simulator(exper_ts, ~ ns(time, df = 7) * group, ~ GaussianLSS()) |>\n  estimate(nu = 0.01, mstop = 1000)\n\nsample(sim) |>\n  exper_lineplot()## Warning: Removed 6 rows containing missing values or values outside the scale range (`geom_point()`).\nsim <- sim |>\n  scDesigner::mutate(\n    1:2,\n    link = ~ ns(time, df = 7)\n  ) |>\n  estimate(nu = 0.01, mstop = 1000)\n\nsample(sim) |>\n  exper_lineplot()\nsim <- sim |>\n  scDesigner::mutate(1:2, link = ~ ns(time, df = 7)) |>\n  estimate(nu = 0.01, mstop = 1000)\n\nsample(sim) |>\n  exper_lineplot()## Warning: Removed 4 rows containing missing values or values outside the scale range (`geom_point()`).\nsessionInfo()## R version 4.4.1 Patched (2024-08-21 r87049)\n## Platform: aarch64-apple-darwin20\n## Running under: macOS Sonoma 14.5\n## \n## Matrix products: default\n## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \n## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n## \n## locale:\n## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n## \n## time zone: America/Chicago\n## tzcode source: internal\n## \n## attached base packages:\n##  [1] splines   parallel  stats4    stats     graphics  grDevices utils     datasets  methods   base     \n## \n## other attached packages:\n##  [1] ggpubr_0.6.0                    ggrepel_0.9.6                   edgeR_4.3.16                    limma_3.61.10                   ANCOMBC_2.7.0                  \n##  [6] stringr_1.5.1                   ks_1.14.3                       tidySummarizedExperiment_1.15.1 ttservice_0.4.1                 SimBench_0.99.1                \n## [11] wesanderson_0.3.7               mia_1.13.36                     MultiAssayExperiment_1.31.5     TreeSummarizedExperiment_2.13.0 Biostrings_2.73.1              \n## [16] XVector_0.45.0                  SingleCellExperiment_1.27.2     gamlss_5.4-22                   nlme_3.1-166                    gamlss.dist_6.1-1              \n## [21] gamlss.data_6.0-6               scDesigner_0.0.0.9000           purrr_1.0.2                     MIGsim_0.0.0.9000               tidyr_1.3.1                    \n## [26] tibble_3.2.1                    scico_1.5.0                     pwr_1.3-0                       patchwork_1.3.0                 mutoss_0.1-13                  \n## [31] mvtnorm_1.3-1                   mixOmics_6.29.0                 lattice_0.22-6                  MASS_7.3-61                     glue_1.7.0                     \n## [36] ggplot2_3.5.1                   ggdist_3.3.2                    gamboostLSS_2.0-7               mboost_2.9-11                   stabs_0.6-4                    \n## [41] forcats_1.0.0                   dplyr_1.1.4                     SummarizedExperiment_1.35.1     Biobase_2.65.1                  GenomicRanges_1.57.1           \n## [46] GenomeInfoDb_1.41.1             IRanges_2.39.2                  S4Vectors_0.43.2                BiocGenerics_0.51.1             MatrixGenerics_1.17.0          \n## [51] matrixStats_1.4.1               SpiecEasi_1.1.3                 CovTools_0.5.4                 \n## \n## loaded via a namespace (and not attached):\n##   [1] igraph_2.0.3                ica_1.0-3                   plotly_4.10.4               Formula_1.2-5               scater_1.33.4               devtools_2.4.5             \n##   [7] zlibbioc_1.51.1             tidyselect_1.2.1            bit_4.5.0                   doParallel_1.0.17           pspline_1.0-20              blob_1.2.4                 \n##  [13] urlchecker_1.0.1            rngtools_1.5.2              S4Arrays_1.5.8              png_0.1-8                   plotrix_3.8-4               cli_3.6.3                  \n##  [19] CVXR_1.0-14                 pulsar_0.3.11               multtest_2.61.0             goftest_1.2-3               bluster_1.15.1              BiocNeighbors_1.99.1       \n##  [25] uwot_0.2.2                  curl_5.2.3                  mime_0.12                   evaluate_1.0.0              tidytree_0.4.6              leiden_0.4.3.1             \n##  [31] stringi_1.8.4               backports_1.5.0             desc_1.4.3                  lmerTest_3.1-3              Exact_3.3                   gsl_2.1-8                  \n##  [37] httpuv_1.6.15               AnnotationDbi_1.67.0        magrittr_2.0.3              mclust_6.1.1                ADGofTest_0.3               doRNG_1.8.6                \n##  [43] pcaPP_2.0-5                 rootSolve_1.8.2.4           sctransform_0.4.1           lpSolve_5.6.21              ggbeeswarm_0.7.2            sessioninfo_1.2.2          \n##  [49] DBI_1.2.3                   jquerylib_0.1.4             withr_3.0.1                 corpcor_1.6.10              class_7.3-22                lmtest_0.9-40              \n##  [55] BiocManager_1.30.25         htmlwidgets_1.6.4           fs_1.6.4                    labeling_0.4.3              SparseArray_1.5.38          cellranger_1.1.0           \n##  [61] DESeq2_1.45.3               extrafont_0.19              lmom_3.0                    flare_1.7.0.1               reticulate_1.39.0           minpack.lm_1.2-4           \n##  [67] geigen_2.3                  zoo_1.8-12                  knitr_1.48                  nnls_1.5                    UCSC.utils_1.1.0            SHT_0.1.8                  \n##  [73] decontam_1.25.0             foreach_1.5.2               fansi_1.0.6                 grid_4.4.1                  data.table_1.16.0           vegan_2.6-8                \n##  [79] RSpectra_0.16-2             irlba_2.3.5.1               extrafontdb_1.0             DescTools_0.99.56           fastDummies_1.7.4           ellipsis_0.3.2             \n##  [85] lazyeval_0.2.2              yaml_2.3.10                 survival_3.7-0              scattermore_1.2             crayon_1.5.3                mediation_4.5.0            \n##  [91] RcppAnnoy_0.0.22            RColorBrewer_1.1-3          progressr_0.14.0            later_1.3.2                 ggridges_0.5.6              codetools_0.2-20           \n##  [97] base64enc_0.1-3             profvis_0.4.0               Seurat_5.1.0                KEGGREST_1.45.1             Rtsne_0.17                  shape_1.4.6.1              \n## [103] randtoolbox_2.0.4           foreign_0.8-87              pkgconfig_2.0.3             xml2_1.3.6                  spatstat.univar_3.0-1       downlit_0.4.4              \n## [109] scatterplot3d_0.3-44        spatstat.sparse_3.1-0       ape_5.8                     viridisLite_0.4.2           xtable_1.8-4                highr_0.11                 \n## [115] car_3.1-2                   fastcluster_1.2.6           plyr_1.8.9                  httr_1.4.7                  rbibutils_2.2.16            tools_4.4.1                \n## [121] globals_0.16.3              SeuratObject_5.0.2          kde1d_1.0.7                 pkgbuild_1.4.4              broom_1.0.6                 beeswarm_0.4.0             \n## [127] htmlTable_2.4.3             checkmate_2.3.2             rgl_1.3.1                   assertthat_0.2.1            lme4_1.1-35.5               rngWELL_0.10-9             \n## [133] digest_0.6.37               permute_0.9-7               numDeriv_2016.8-1.1         bookdown_0.40               Matrix_1.7-0                farver_2.1.2               \n## [139] reshape2_1.4.4              yulab.utils_0.1.7           viridis_0.6.5               DirichletMultinomial_1.47.0 rpart_4.1.23                cachem_1.1.0               \n## [145] polyclip_1.10-7             WGCNA_1.73                  Hmisc_5.1-3                 generics_0.1.3              dynamicTreeCut_1.63-1       parallelly_1.38.0          \n## [151] pkgload_1.4.0               statmod_1.5.0               impute_1.79.0               huge_1.3.5                  RcppHNSW_0.6.0              ScaledMatrix_1.13.0        \n## [157] carData_3.0-5               minqa_1.2.8                 pbapply_1.7-2               glmnet_4.1-8                spam_2.10-0                 utf8_1.2.4                 \n## [163] gtools_3.9.5                shapes_1.2.7                readxl_1.4.3                preprocessCore_1.67.0       inum_1.0-5                  ggsignif_0.6.4             \n## [169] energy_1.7-12               gridExtra_2.3               shiny_1.9.1                 GenomeInfoDbData_1.2.12     memoise_2.0.1               rmarkdown_2.28             \n## [175] scales_1.3.0                gld_2.6.6                   stabledist_0.7-2            partykit_1.2-22             future_1.34.0               RANN_2.6.2                 \n## [181] spatstat.data_3.1-2         rstudioapi_0.16.0           cluster_2.1.6               spatstat.utils_3.1-0        hms_1.1.3                   fitdistrplus_1.2-1         \n## [187] munsell_0.5.1               cowplot_1.1.3               colorspace_2.1-1            ellipse_0.5.0               rlang_1.1.4                 quadprog_1.5-8             \n## [193] copula_1.1-4                DelayedMatrixStats_1.27.3   sparseMatrixStats_1.17.2    dotCall64_1.1-1             scuttle_1.15.4              mgcv_1.9-1                 \n## [199] xfun_0.47                   e1071_1.7-16                TH.data_1.1-2               remotes_2.5.0               iterators_1.0.14            rARPACK_0.11-0             \n## [205] abind_1.4-8                 libcoin_1.0-10              treeio_1.29.1               gmp_0.7-5                   DECIPHER_3.1.4              Rdpack_2.6.1               \n## [211] ps_1.8.0                    promises_1.3.0              RSQLite_2.3.7               sandwich_3.1-1              proxy_0.4-27                DelayedArray_0.31.11       \n## [217] Rmpfr_0.9-5                 GO.db_3.20.0                compiler_4.4.1              prettyunits_1.2.0           boot_1.3-31                 distributional_0.5.0       \n## [223] beachmat_2.21.6             rbiom_1.0.3                 listenv_0.9.1               Rcpp_1.0.13                 Rttf2pt1_1.3.12             BiocSingular_1.21.4        \n## [229] tensor_1.5                  usethis_3.0.0               progress_1.2.3              BiocParallel_1.39.0         insight_0.20.4              spatstat.random_3.3-2      \n## [235] R6_2.5.1                    rstatix_0.7.2               fastmap_1.2.0               multcomp_1.4-26             vipor_0.4.7                 ROCR_1.0-11                \n## [241] rsvd_1.0.5                  nnet_7.3-19                 gtable_0.3.5                KernSmooth_2.23-24          miniUI_0.1.1.1              deldir_2.0-4               \n## [247] ggthemes_5.1.0              htmltools_0.5.8.1           RcppParallel_5.1.9          bit64_4.5.2                 spatstat.explore_3.3-2      lifecycle_1.0.4            \n## [253] processx_3.8.4              nloptr_2.1.1                callr_3.7.6                 sass_0.4.9                  vctrs_0.6.5                 VGAM_1.1-12                \n## [259] slam_0.1-53                 spatstat.geom_3.3-3         sp_2.1-4                    future.apply_1.11.2         pracma_2.4.4                rvinecopulib_0.6.3.1.1     \n## [265] bslib_0.8.0                 pillar_1.9.0                locfit_1.5-9.10             jsonlite_1.8.9              expm_1.0-0"},{"path":"simulating-differential-abundance.html","id":"simulating-differential-abundance","chapter":"2 Simulating Differential Abundance","heading":"2 Simulating Differential Abundance","text":"consider simulating entire microbial communities, complex\ncorrelation structures, let’s learn simulators individual taxa. \nalready enough analyze taxon-level differential abundance approaches. \nexample, end session, ’ll apply simulator study power\nfalse discovery rate limma-voom applied microbiome data (\nopposed bulk RNA-seq data originally proposed). Also,\nmarginal modeling first step towards multivariate (community-wide)\nmodeling, ’ll explore next session.Let’s load necessary packages. Instructions scDesigner MIGsim\ncan found pre-workshop announcement. SummarizedExperiment \nBioconductor, packages CRAN.Let’s train simulator fit Atlas dataset. ’ll use bmi_group \ncovariate interest – want see microbiome composition varies among\npeople different BMI. found helpful\nfixed zero inflation across population (nu), set nu = ~1.\nFinally, since want eventually evaluate testing methods designed\ncount data, used (Z)ero ()nflated (N)egative (B)inomial\nlocation-shape-scale model.’ll remove genera never observed dataset.Next select features work ZINBF() estimation.","code":"\ndata(atlas1006, package = \"microbiome\")\natlas <- makeTreeSEFromPhyloseq(atlas1006) |>\n  filter(time == 0) |>\n  dplyr::mutate(\n    bmi_group = case_when(\n      bmi_group == \"severeobese\" ~ \"obese\",\n      bmi_group == \"morbidobese\" ~ \"obese\",\n      bmi_group == \"obese\" ~ \"obese\",\n      bmi_group == \"lean\" ~ \"lean\",\n      bmi_group == \"overweight\" ~ \"overweight\",\n    )\n  ) |>\n  dplyr::filter(bmi_group %in% c(\"obese\", \"lean\", \"overweight\")) |>\n  dplyr::mutate(\n    bmi_group = factor(bmi_group, levels = c(\"obese\", \"overweight\", \"lean\"))\n  )\n\nfmla <- list(\n  mu = ~bmi_group,\n  sigma = ~bmi_group,\n  nu = ~1\n)\ncolData(atlas)$log_depth <- log(colSums(assay(atlas)))\nzero_var <- apply(assay(atlas), 1, var) == 0\natlas <- atlas[!zero_var, ]\nselect_i <- c(1:2)\ncolData(atlas) <- colData(atlas)[, c(\"bmi_group\", \"sample\")]\n\nfor (i in 3:dim(atlas)[1]) {\n  # print(select_i)\n  # print(glue::glue(\"{i}/{dim(atlas)[1]}\"))\n  exper_tmp <- atlas[c(select_i, i), ]\n  sim <- setup_simulator(\n    exper_tmp,\n    fmla,\n    ~ ZINBF()\n  )\n\n  error_warning <- estimate(sim, control = gamlss.control(\n    n.cyc = 20,\n    mu.step = 0.1\n  )) |>\n    tryCatch(warning = function(w) w, error = function(e) e)\n\n  if (is.na(class(error_warning)[2])) {\n    select_i <- c(select_i, i)\n  }\n}\ncolData(atlas) <- colData(atlas)[, c(\"bmi_group\", \"sample\")]\natlas_filteres <- atlas[select_i, ]\n\nsim <- setup_simulator(\n  atlas_filteres,\n  fmla,\n  ~ ZINBF()\n)\n\n\nsim <- estimate(sim, control = gamlss.control(\n  n.cyc = 20,\n  mu.step = 0.1\n))"},{"path":"simulating-differential-abundance.html","id":"critique","chapter":"2 Simulating Differential Abundance","heading":"2.1 Critique","text":"Exercise: block combines real simulated experiments \nvisualizes difference graphically quantitatively. \nneighbors, discuss well simulator approximates original template.Solution: simulated data generally similar original data.\nHowever, genera positively skewed distributions high number\noutliers, Prevotella melaninogenica et rel,\nsimulation reached limits, explaining kernel density-based\ntwo-sample test returned significant differences real simulated\ndata genera. Nonetheless, ordering abundances\ngroups typically agrees real simulated data. \ninterquartile ranges taxon also seem roughly match.","code":"\nreal <- atlas_filteres\nsimulated <- sample(sim)\ncombined <- bind_rows(\n  real = pivot_experiment(real), # real data\n  simulated = pivot_experiment(simulated), # simulated\n  .id = \"source\"\n)\n\ntop_features <- assay(atlas_filteres) |>\n  rowMeans() |>\n  sort() |>\n  tail(10) |>\n  names()\n\ntop_combined <- combined |>\n  filter(feature %in% top_features)\n\nggplot(top_combined) +\n  geom_boxplot(\n    aes(sqrt(value), reorder(feature, value, median), fill = bmi_group)\n  ) +\n  facet_grid(. ~ source) +\n  xlab(\"Square root transformed counts\") +\n  ylab(\"\") +\n  labs(fill = \"BMI group\") +\n  theme(legend.position = \"right\") +\n  scale_fill_manual(values = rev(c(\"#9491D9\", \"#3F8C61\", \"#F24405\")))\nkdetest.group <- function(data) {\n  x <- data |> filter(source == \"real\")\n  y <- data |> filter(source == \"simulated\")\n  res <- kde.test(x1 = x$value, x2 = y$value)$pvalue\n  res\n}\n\nprop.accepted.H0 <- sapply(\n  c(\"lean\", \"overweight\", \"obese\"),\n  function(group) {\n    group_filter <- map(\n      unique(combined$feature),\n      ~ combined |>\n        filter(feature == . &\n          bmi_group == group)\n    )\n    adjpvalue <- sapply(\n      1:length(select_i),\n      function(i) {\n        tryCatch(\n          {\n            kdetest.group(\n              group_filter[[i]]\n            )\n          },\n          error = function(e) {\n            NA\n          }\n        )\n      }\n    ) |>\n      p.adjust(method = \"BH\")\n    sum(adjpvalue > 0.05, na.rm = TRUE) /\n      sum(!is.na(adjpvalue))\n  }\n)\nprop.accepted.H0##       lean overweight      obese \n##  0.7441860  0.7857143  0.7380952"},{"path":"simulating-differential-abundance.html","id":"power-analysis-loop","chapter":"2 Simulating Differential Abundance","heading":"2.2 Power Analysis Loop","text":"run power analysis, need define datasets known ground\ntruth. , can run differential abundance methods want see \nmany true associations recovered (many nulls falsely\nrejected). end, ’ll remove associations genera based Wilcoxon\nRank Sum test. ’ll choose remove genera q valuse<0.1\noriginal data.helpful , even use bmi_group \nformula, reality (weak) effect, even \nsimulator considers true signal, difference may hard detect.\nEventually, package include functions modifying effects\ndirectly; point, though, can indirectly modify parameters \nre-estimating new formulas.Now ground truth associations, ’ll evaluate LIMMA-voom, ANCOMBC,\nDESeq2 differential analysis. consider sample sizes ranging 50 \n1200, simulate 20 datasets sample size.Exercise: Visualize results. interpret results \npower analysis? Based earlier critique simulator, think\nestimated power conservative, liberal, right?Solution: ’ll use stat_pointinterval function ggdist package \nvisualize range empirical power estimates across sample sizes. can see\naverage false discovery proportion always controlled 0.1,\nthough variance proportion can high. can also see \nquite good power \\(n \\geq 625\\) samples, worst case\nscenarios can quite poor anything fewer samples.","code":"\nwilcox_res <- differential_analysis(atlas_filteres, \"wilcox-clr\")\nnulls <- wilcox_res[wilcox_res$q_value.bmi_group. > 0.1, ] |>\n  rownames()\n\nsim <- sim |> scDesigner::mutate(any_of(nulls), link = ~1)\nsim <- estimate(sim, control = gamlss.control(\n  n.cyc = 20,\n  mu.step = 0.1\n))\nconfig <- expand.grid(\n  sample_size = floor(seq(50, 1200, length.out = 5)),\n  n_rep = 1:20\n) |>\n  mutate(run = as.character(row_number()))\n\nsample_n_ <- function(sim_object, sample_size) {\n  n_original <- ncol(sim_object@template)\n  rep_ix <- rep(seq_len(n_original), each = ceiling(sample_size / n_original))\n  new_data <- colData(sim_object@template)[rep_ix[1:sample_size], ] |>\n    as_tibble() |>\n    mutate(\n      newdata_index = row_number()\n    )\n\n  sim_return <- sample(sim_object, new_data = new_data)\n  return(sim_return)\n}\n\nresults <- list()\nfor (i in seq_len(nrow(config))) {\n  atlas_ <- sample_n_(sim, config$sample_size[i])\n  colnames(atlas_) <- paste0(\"Sample-\", 1:config$sample_size[i])\n  results[[i]] <- sapply(c(\"LIMMA_voom\", \"ANCOMBC\", \"DESeq2\"),\n    function(m) {\n      differential_analysis(atlas_, m) |>\n        da_metrics(nulls)\n    },\n    simplify = FALSE\n  )\n  # print(glue::glue(\"{i}/{nrow(config)}\"))\n}\npower_fdr <- sapply(1:100, function(i) {\n  bind_rows(results[[i]], .id = \"method\")\n},\nsimplify = FALSE\n) |>\n  bind_rows(.id = \"run\") |>\n  dplyr::mutate(sample_size = rep(config$sample_size, each = 6))\n\nggplot(power_fdr) +\n  tidybayes::stat_pointinterval(aes(factor(sample_size), value, group = method, colour = method),\n    position = position_dodge(width = 0.8)\n  ) +\n  facet_wrap(~metric) +\n  xlab(\"Sample size\") +\n  ylab(\"\") +\n  scale_color_manual(values = wes_palette(\"Moonrise2\", n = 3)) +\n  labs(color = \"Method\") +\n  theme(legend.position = \"right\")\nsessionInfo()## R version 4.4.0 (2024-04-24)\n## Platform: aarch64-apple-darwin20\n## Running under: macOS Ventura 13.4\n## \n## Matrix products: default\n## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \n## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n## \n## locale:\n## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n## \n## time zone: America/Chicago\n## tzcode source: internal\n## \n## attached base packages:\n##  [1] splines   parallel  stats4    stats     graphics  grDevices utils     datasets  methods   base     \n## \n## other attached packages:\n##  [1] TreeSummarizedExperiment_2.12.0 Biostrings_2.72.1               XVector_0.44.0                  SingleCellExperiment_1.26.0     scDesigner_0.0.0.9000           purrr_1.0.2                    \n##  [7] MIGsim_0.0.0.9000               tidyr_1.3.1                     tibble_3.2.1                    scico_1.5.0                     pwr_1.3-0                       patchwork_1.2.0                \n## [13] mixOmics_6.28.0                 lattice_0.22-6                  MASS_7.3-60.2                   glue_1.7.0                      ggplot2_3.5.1                   ggdist_3.3.2                   \n## [19] gamboostLSS_2.0-7               mboost_2.9-10                   stabs_0.6-4                     forcats_1.0.0                   dplyr_1.1.4                     SummarizedExperiment_1.34.0    \n## [25] Biobase_2.64.0                  GenomicRanges_1.56.0            GenomeInfoDb_1.40.0             IRanges_2.38.0                  S4Vectors_0.42.0                BiocGenerics_0.50.0            \n## [31] MatrixGenerics_1.16.0           matrixStats_1.3.0               SpiecEasi_1.1.3                 CovTools_0.5.4                 \n## \n## loaded via a namespace (and not attached):\n##   [1] minpack.lm_1.2-4        rpart_4.1.23            lifecycle_1.0.4         Rdpack_2.6              edgeR_4.2.0             doParallel_1.0.17       insight_0.20.1          magrittr_2.0.3         \n##   [9] limma_3.60.2            sass_0.4.9              rmarkdown_2.27          jquerylib_0.1.4         yaml_2.3.8              RColorBrewer_1.1-3      ADGofTest_0.3           abind_1.4-5            \n##  [17] zlibbioc_1.50.0         expm_0.999-9            quadprog_1.5-8          pspline_1.0-20          kde1d_1.0.7             rgl_1.3.1               yulab.utils_0.1.4       pracma_2.4.4           \n##  [25] GenomeInfoDbData_1.2.12 ggrepel_0.9.5           tidytree_0.4.6          ellipse_0.5.0           RSpectra_0.16-1         svglite_2.1.3           codetools_0.2-20        DelayedArray_0.30.1    \n##  [33] shapes_1.2.7            tidyselect_1.2.1        shape_1.4.6.1           UCSC.utils_1.0.0        farver_2.1.2            randtoolbox_2.0.4       base64enc_0.1-3         jsonlite_1.8.8         \n##  [41] Formula_1.2-5           survival_3.7-0          iterators_1.0.14        systemfonts_1.1.0       foreach_1.5.2           tools_4.4.0             progress_1.2.3          treeio_1.28.0          \n##  [49] ragg_1.3.2              Rcpp_1.0.12             rARPACK_0.11-0          gridExtra_2.3           SparseArray_1.4.8       xfun_0.44               distributional_0.4.0    withr_3.0.0            \n##  [57] numDeriv_2016.8-1.1     fastmap_1.2.0           fansi_1.0.6             digest_0.6.35           R6_2.5.1                textshaping_0.4.0       colorspace_2.1-0        inum_1.0-5             \n##  [65] copula_1.1-3            flare_1.7.0.1           utf8_1.2.4              generics_0.1.3          corpcor_1.6.10          prettyunits_1.2.0       pulsar_0.3.11           httr_1.4.7             \n##  [73] htmlwidgets_1.6.4       S4Arrays_1.4.1          scatterplot3d_0.3-44    rngWELL_0.10-9          pkgconfig_2.0.3         geigen_2.3              gtable_0.3.5            pcaPP_2.0-4            \n##  [81] htmltools_0.5.8.1       bookdown_0.39.1         scales_1.3.0            SHT_0.1.8               knitr_1.47              rstudioapi_0.16.0       reshape2_1.4.4          nlme_3.1-164           \n##  [89] cachem_1.1.0            stringr_1.5.1           libcoin_1.0-10          pillar_1.9.0            grid_4.4.0              vctrs_0.6.5             VGAM_1.1-11             huge_1.3.5             \n##  [97] gamlss.dist_6.1-1       evaluate_0.23           mvtnorm_1.2-5           cli_3.6.3               locfit_1.5-9.9          compiler_4.4.0          rlang_1.1.4             crayon_1.5.3           \n## [105] labeling_0.4.3          plyr_1.8.9              fs_1.6.4                stringi_1.8.4           BiocParallel_1.38.0     nnls_1.5                assertthat_0.2.1        rvinecopulib_0.6.3.1.1 \n## [113] munsell_0.5.1           gsl_2.1-8               lazyeval_0.2.2          glmnet_4.1-8            Matrix_1.7-0            hms_1.1.3               stabledist_0.7-1        statmod_1.5.0          \n## [121] highr_0.11              rbibutils_2.2.16        partykit_1.2-20         igraph_2.0.3            memoise_2.0.1           bslib_0.7.0.9000        ape_5.8"},{"path":"multivariate-power-analysis.html","id":"multivariate-power-analysis","chapter":"3 Multivariate Power Analysis","heading":"3 Multivariate Power Analysis","text":"can choose sample sizes complex bioinformatic workflows, \nsimultaneously analyze many features (taxa, genes, metabolites) concert?\ntraditional, analytical power analysis often breaks , simulation can\nstill effective. ’ll look concrete case study try choose \ngood sample size sparse partial least squares discriminant analysis\n(sPLS-DA) Type Diabetes (T1D) gut microbiome.First, ’ll load required packages. Relative first session, \nadditional package need mixOmics. can installed using\nBiocManager::install('mixOmics').","code":""},{"path":"multivariate-power-analysis.html","id":"interpreting-pls-da","chapter":"3 Multivariate Power Analysis","heading":"3.1 Interpreting PLS-DA","text":"T1D dataset describes 427 metabolites gut microbiomes 40\nT1D patients 61 healthy controls. data originally gathered \nGavin et al. (2018), motivated \nrelationship pancreas intestinal issues often experienced \nT1D patients. especially curious whether microbime-associated\nproteins might related increased risk T1D development.output care PLD-DA scores loadings. wrapper\ndirectly gives us output without explicitly set\nhyerparameters, though can look \nsee function defined.Exercise: Discuss output plotIndiv. plotVar shape\ninterpretation?Solution: first two dimensions sPLS-DA pick distinctions T1D\n(orange) control (blue) groups. variance first two dimensions\nrelatively small\n– variation protein signatures may easiliy captured two dimensions\nmay generally correlated disease response. Since \ndifferences groups captured first dimension, can look \nfeatures highly correlated dimension see proteins\nmight driving difference. example, can conclude T1D samples\ntend higher levels \np21333 \nq8wz42 compared \ncontrols.","code":"\ndata(t1d)\nresult <- splsda_fit(t1d)\nplotIndiv(result$fit, cex = 5)\nplotVar(result$fit, cutoff = 0.4, cex = 5)"},{"path":"multivariate-power-analysis.html","id":"estimation","chapter":"3 Multivariate Power Analysis","heading":"3.2 Estimation","text":"Let’s estimate simulator every protein allowed ot vary across T1D\ntype. Since data already centered log-ratio transformed, ’s okay\ntreat Gaussian.","code":"\nsimulator <- setup_simulator(t1d, link_formula = ~outcome2, family = ~ GaussianLSS()) |>\n  estimate(mstop = 100)"},{"path":"multivariate-power-analysis.html","id":"evaluation","chapter":"3 Multivariate Power Analysis","heading":"3.3 Evaluation","text":"Last time, saw visualize marginal simulator quality. can \ntell whether joint simulator working, though? One simple check \nanalyze pairwise correlations. Since copula model designed capture\nsecond-order moments, least effectively capture \ncorrelations.’ve written small helper visualizes pairwise protein-protein\ncorrelations real simulated datasets. seem often\noverestimating correlation strength. likely consequence \nhigh-dimensionality problem.Exercise: address , let’s try modifying copula_def argument \nsetup_simulator use suitable simulator. Generate new correlation\nhistograms comment changes observe. need modify \ncommented lines (#) lines block .Solution: coupla, can use covariance estimator Cai Liu\n(2011), \nsuited high dimensions. Larger values thr increase stability\nestimates, cost potentially missing weakening true\ncorrelations. line point, new simulated correlations \nconcentrated.choose threshold? can compare correlations \nsystematically using loop:","code":"\nsim_exper <- sample(simulator)\ncorrelation_hist(t1d, sim_exper)\nsimulator <- setup_simulator(\n  t1d,\n  link_formula = ~outcome2,\n  family = ~ GaussianLSS(),\n  copula_def = # fill this code in\n  ) |>\n  estimate(mstop = 100)\n\nsim_exper <- sample(simulator) # and then run these two lines\ncorrelation_hist(t1d, sim_exper) #\nsimulator <- setup_simulator(\n  t1d,\n  link_formula = ~outcome2,\n  family = ~ GaussianLSS(),\n  copula_def = copula_adaptive(thr = 0.1)\n) |>\n  estimate(mstop = 100)\n\nsim_exper <- sample(simulator)\ncorrelation_hist(t1d, sim_exper)\ncontrast_boxplot(t1d, sim_exper, ~. ~ reorder(outcome2, value))\nrhos <- list(sim = cor(t(assay(sim_exper))), real = cor(t(assay(t1d))))\ndiag(rhos[[1]]) <- NA\ntop_cors <- which(abs(rhos[[1]]) > quantile(abs(rhos[[1]]), 0.999, na.rm = TRUE), arr.ind = TRUE)\n\npairs_data <- list(\n  real = subset_correlated(assay(t1d), top_cors),\n  simulated = subset_correlated(assay(sim_exper), top_cors)\n) |>\n  bind_rows(.id = \"source\")\n\nkeep_pairs <- pairs_data |>\n  dplyr::select(source, pair, correlation) |>\n  unique() |>\n  filter(source == \"real\", correlation > 0.72, correlation < 0.8) |>\n  pull(pair)\n\np1 <- pairs_data |>\n  filter(pair %in% keep_pairs) |>\n  ggplot() +\n  geom_point(aes(feature1, feature2, col = source), alpha = 0.5, size = 1) +\n  scale_color_manual(values = c(\"#038C8C\", \"#D93636\")) +\n  guides(color = guide_legend(override.aes = list(alpha = 1, size = 2))) +\n  labs(title = \"A\", col = \"Source\", x = expression(\"Feature\" ~ j), y = expression(\"Feature\" ~ j^\"'\")) +\n  facet_wrap(~ reorder(pair, -correlation), ncol = 6, scales = \"free\") +\n  theme(\n    strip.text = element_text(size = 7),\n    axis.text = element_text(size = 8)\n  )\nft_order <- hclust(dist(assay(t1d)))$order\np2 <- correlation_heatmap(rhos$real, ft_order) +\n  labs(title = \"B  Real\") +\n  (correlation_heatmap(rhos$sim, ft_order) +\n    labs(title = \"Simulated\") +\n    theme(legend.position = \"none\"))\n\n(p1 / p2) +\n  plot_layout(guides = \"collect\", heights = c(1.2, 2))\nbivariate_metrics <- \\(thr, n_rep = 5) {\n  # refit the simulator with current threshold\n  simulator <- setup_simulator(\n    t1d,\n    link_formula = ~outcome2,\n    family = ~ GaussianLSS(),\n    copula_def = copula_adaptive(thr = thr)\n  ) |>\n    estimate(mstop = 100)\n\n  # compute metrics on five samples\n  err <- list()\n  for (i in 1:n_rep) {\n    sim_exper <- sample(simulator)[rownames(t1d), ]\n    rhos <- list(sim = cor(t(assay(sim_exper))), real = cor(t(assay(t1d))))\n    err[[i]] <- data.frame(\n      frobenius = sqrt(mean((rhos$sim - rhos$real)^2)),\n      ks = ks.test(rhos$sim, rhos$real)$statistic,\n      thr = thr\n    )\n  }\n\n  do.call(rbind, err)\n}\nerrors <- seq(.001, 0.2, length.out = 10) |>\n  map_dfr(bivariate_metrics) |>\n  pivot_longer(-thr, names_to = \"metric\")\n\nggplot(errors) +\n  geom_point(aes(thr, value)) +\n  facet_wrap(~metric, scales = \"free_y\") +\n  labs(x = \"Threshold\", y = \"Metric Value\")"},{"path":"multivariate-power-analysis.html","id":"pls-da-power-analysis","chapter":"3 Multivariate Power Analysis","heading":"3.4 PLS-DA Power Analysis","text":"Now simulator, can run power analysis. theory, \nlook summary PLS-DA output varies sample size\nincreases. natural one, though, simply see classifier\nperformance improves gather samples. Specifically, ’ll measure \nholdout Area Curve (auc), measure well trains PLS-DA\nclassifier balance precision recall new samples.Moreover, ’ll study effect sparsity – happens many features\nrelationship response? ’ll also simulate three\nhypothetical datasets sample size sparsity level. \nconfigurations interest stored config matrix .Exercise: Finally, ’re position generate synthetic data \nevaluate PLS-DA performance. Fill block update simulator \n. Remember original simulator defined assumes \nproteins associated T1D. can use t1d_order prioritize \nproteins strongest effects original data. , \nneed modify line marked comments (#).Solution: define nulls, mutate weakest proteins longer \nassociation T1D: link = ~ 1 instead link = ~ outcome2. speed \ncomputation, organized mutate calls don’t need \nre-estimate proteins whose effects removed previous iteration.:::can visualize variation performance.Discussion: Interpret visualization . think analysis\nlike help justify making experimental investments \nothers?Solution: Reading across facets top left bottom right, power decreases \nnumber null proteins increases. seems sPLS-DA can benefit \nmany weakly associated features. power sometimes high low sample\nsizes, variance can quite large. settings, noticeable\ndecrease variance power go 15 48 samples. can assume\nmoderate fraction (> 15%) measured proteins associated T1D,\nmay already achieve good power ~ 100 samples. However, \nimagine effect might sparser future experiment, figure\ngive us good justification arguing larger number samples, \norder ensure can discover disease-associated proteomics signature.","code":"\nconfig <- expand.grid(\n  sample_size = floor(seq(20, 200, length.out = 5)),\n  n_rep = 1:20,\n  n_null = floor(seq(317, 417, length.out = 4)),\n  metrics = NA\n)\n\ndata(t1d_order)\nfor (i in seq_len(nrow(config))) {\n  simulator <- simulator |>\n    mutate(\n      # fill this in\n    ) |>\n    estimate(mstop = 100)\n\n  config$metrics[i] <- (sample_n(simulator, config$sample_size[i]) |>\n    splsda_fit())[[\"auc\"]]\n  print(glue(\"run {i}/{nrow(config)}\"))\n}\nfor (i in seq_len(nrow(config))) {\n  if (i == 1 || config$n_null[i] != config$n_null[i - 1]) {\n    simulator <- simulator |>\n      scDesigner::mutate(any_of(rev(t1d_order)[1:config$n_null[i]]), link = ~1) |>\n      estimate(mstop = 100)\n  }\n\n  config$metrics[i] <- (sample_n(simulator, config$sample_size[i]) |>\n    splsda_fit())[[\"auc\"]]\n  print(glue(\"run {i}/{nrow(config)}\"))\n}\nconfig <- readRDS(url(\"https://uwmadison.box.com/shared/static/tf1xyo7a2n2rd2ms4y9itaev42dsnp5c.rds\"))\np3 <- ggplot(config, aes(factor(sample_size), metrics, col = factor(n_null))) +\n  stat_pointinterval(position = \"dodge\") +\n  scale_color_scico_d(palette = \"managua\") +\n  labs(x = \"Sample Size\", y = \"AUC\", color = \"# Nulls\", title = \"C\")\n\n(p1 / p2 / p3) +\n  plot_layout(guides = \"collect\", heights = c(1.2, 2, 1))\nix <- colData(t1d)$outcome2 == \"T1D\"\np_vals <- apply(assay(t1d), 1, \\(x) t.test(x[ix], x[-ix])$p.value)\nstorey_pi0_est(p_vals, 0.5)$pi0## [1] 1.311475"},{"path":"multivariate-power-analysis.html","id":"comparison-with-t-test-calculation","chapter":"3 Multivariate Power Analysis","heading":"3.5 Comparison with \\(t\\)-test calculation","text":"based power analysis using theory \\(t\\)-tests? might \nhopeful theory might give sample size also good enough \nsPLS-DA. make concrete, suppose test 427 taxa using\ntwo-sample \\(t\\)-test Benjamini-Hochberg correction multiple testing.\nSuppose sparse case, 10 nonnull taxa. \nhypothetical true signal strength, use observed signal strength \ntenth significant taxon real data,many samples need order achieve 80% power setting?\nAccounting multiple testing, need taxon significant \nlevel \\(\\frac{10 \\alpha}{427}\\), gives us,, according power analysis, need 11 samples \nhealthy disease groups. comparison earlier analysis using sPLS-DA,\noptimistic. case 10 taxa significant, \n20 samples total, AUC range \\(\\left[\\right]\\), \nslightly better random guessing. case \\(t\\)-test power\ncalculation make us overoptimistic number samples \nrequired. data generation (two shifted normal distributions) \nanalysis (\\(t\\)-tests BH correction) mechanisms assumed power\nanalysis suspect, case makes difference. power analysis\nrequires simplification, fact realistic simulator\npoints us towards noticeably larger sample sizes indication \ntrust \\(t\\)-test calculation instead suggest larger sample sample\nsPLS-DA specific analysis.","code":"\nsubset_size <- 10\ny <- colData(t1d)$outcome2\nx <- assay(t1d)[t1d_order[subset_size], ]\ntest_result <- t.test(x[y == \"T1D\"], x[y == \"healthy\"])\nsignal_strength <- test_result$statistic\nsignal_strength##         t \n## -2.092196\nresult <- pwr.t.test(power = 0.8, d = signal_strength, sig.level = 0.05 * subset_size / nrow(t1d))\nresult$n## [1] 10.36249\nsessionInfo()## R version 4.4.1 Patched (2024-08-21 r87049)\n## Platform: aarch64-apple-darwin20\n## Running under: macOS Sonoma 14.5\n## \n## Matrix products: default\n## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \n## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n## \n## locale:\n## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n## \n## time zone: America/Chicago\n## tzcode source: internal\n## \n## attached base packages:\n##  [1] splines   parallel  stats4    stats     graphics  grDevices utils     datasets  methods   base     \n## \n## other attached packages:\n##  [1] doRNG_1.8.6                     rngtools_1.5.2                  foreach_1.5.2                   lubridate_1.9.3                 readr_2.1.5                    \n##  [6] tidyverse_2.0.0                 ggpubr_0.6.0                    ggrepel_0.9.6                   edgeR_4.3.16                    limma_3.61.10                  \n## [11] ANCOMBC_2.7.0                   stringr_1.5.1                   ks_1.14.3                       tidySummarizedExperiment_1.15.1 ttservice_0.4.1                \n## [16] SimBench_0.99.1                 wesanderson_0.3.7               mia_1.13.36                     MultiAssayExperiment_1.31.5     TreeSummarizedExperiment_2.13.0\n## [21] Biostrings_2.73.1               XVector_0.45.0                  SingleCellExperiment_1.27.2     gamlss_5.4-22                   nlme_3.1-166                   \n## [26] gamlss.dist_6.1-1               gamlss.data_6.0-6               scDesigner_0.0.0.9000           purrr_1.0.2                     MIGsim_0.0.0.9000              \n## [31] tidyr_1.3.1                     tibble_3.2.1                    scico_1.5.0                     pwr_1.3-0                       patchwork_1.3.0                \n## [36] mutoss_0.1-13                   mvtnorm_1.3-1                   mixOmics_6.29.0                 lattice_0.22-6                  MASS_7.3-61                    \n## [41] glue_1.7.0                      ggplot2_3.5.1                   ggdist_3.3.2                    gamboostLSS_2.0-7               mboost_2.9-11                  \n## [46] stabs_0.6-4                     forcats_1.0.0                   dplyr_1.1.4                     SummarizedExperiment_1.35.1     Biobase_2.65.1                 \n## [51] GenomicRanges_1.57.1            GenomeInfoDb_1.41.1             IRanges_2.39.2                  S4Vectors_0.43.2                BiocGenerics_0.51.1            \n## [56] MatrixGenerics_1.17.0           matrixStats_1.4.1               SpiecEasi_1.1.3                 CovTools_0.5.4                 \n## \n## loaded via a namespace (and not attached):\n##   [1] igraph_2.0.3                ica_1.0-3                   plotly_4.10.4               Formula_1.2-5               scater_1.33.4               devtools_2.4.5             \n##   [7] zlibbioc_1.51.1             tidyselect_1.2.1            bit_4.5.0                   doParallel_1.0.17           pspline_1.0-20              blob_1.2.4                 \n##  [13] urlchecker_1.0.1            S4Arrays_1.5.8              png_0.1-8                   plotrix_3.8-4               cli_3.6.3                   CVXR_1.0-14                \n##  [19] pulsar_0.3.11               arrayhelpers_1.1-0          multtest_2.61.0             goftest_1.2-3               bluster_1.15.1              BiocNeighbors_1.99.1       \n##  [25] uwot_0.2.2                  curl_5.2.3                  mime_0.12                   evaluate_1.0.0              tidytree_0.4.6              leiden_0.4.3.1             \n##  [31] stringi_1.8.4               backports_1.5.0             desc_1.4.3                  lmerTest_3.1-3              Exact_3.3                   gsl_2.1-8                  \n##  [37] httpuv_1.6.15               AnnotationDbi_1.67.0        magrittr_2.0.3              mclust_6.1.1                ADGofTest_0.3               pcaPP_2.0-5                \n##  [43] rootSolve_1.8.2.4           sctransform_0.4.1           lpSolve_5.6.21              ggbeeswarm_0.7.2            sessioninfo_1.2.2           DBI_1.2.3                  \n##  [49] jquerylib_0.1.4             withr_3.0.1                 corpcor_1.6.10              class_7.3-22                lmtest_0.9-40               BiocManager_1.30.25        \n##  [55] compositions_2.0-8          htmlwidgets_1.6.4           fs_1.6.4                    labeling_0.4.3              SparseArray_1.5.38          DEoptimR_1.1-3             \n##  [61] cellranger_1.1.0            DESeq2_1.45.3               tidybayes_3.0.7             extrafont_0.19              lmom_3.0                    flare_1.7.0.1              \n##  [67] reticulate_1.39.0           minpack.lm_1.2-4            geigen_2.3                  zoo_1.8-12                  knitr_1.48                  nnls_1.5                   \n##  [73] UCSC.utils_1.1.0            svUnit_1.0.6                SHT_0.1.8                   timechange_0.3.0            decontam_1.25.0             fansi_1.0.6                \n##  [79] grid_4.4.1                  rhdf5_2.49.0                data.table_1.16.0           vegan_2.6-8                 RSpectra_0.16-2             irlba_2.3.5.1              \n##  [85] extrafontdb_1.0             DescTools_0.99.56           fastDummies_1.7.4           ellipsis_0.3.2              ade4_1.7-22                 lazyeval_0.2.2             \n##  [91] yaml_2.3.10                 survival_3.7-0              scattermore_1.2             crayon_1.5.3                mediation_4.5.0             tensorA_0.36.2.1           \n##  [97] phyloseq_1.49.0             RcppAnnoy_0.0.22            RColorBrewer_1.1-3          progressr_0.14.0            later_1.3.2                 ggridges_0.5.6             \n## [103] codetools_0.2-20            base64enc_0.1-3             profvis_0.4.0               Seurat_5.1.0                KEGGREST_1.45.1             Rtsne_0.17                 \n## [109] shape_1.4.6.1               randtoolbox_2.0.4           foreign_0.8-87              pkgconfig_2.0.3             xml2_1.3.6                  spatstat.univar_3.0-1      \n## [115] downlit_0.4.4               scatterplot3d_0.3-44        spatstat.sparse_3.1-0       ape_5.8                     viridisLite_0.4.2           xtable_1.8-4               \n## [121] highr_0.11                  car_3.1-2                   fastcluster_1.2.6           plyr_1.8.9                  httr_1.4.7                  rbibutils_2.2.16           \n## [127] tools_4.4.1                 globals_0.16.3              SeuratObject_5.0.2          kde1d_1.0.7                 pkgbuild_1.4.4              broom_1.0.6                \n## [133] beeswarm_0.4.0              htmlTable_2.4.3             checkmate_2.3.2             rgl_1.3.1                   assertthat_0.2.1            lme4_1.1-35.5              \n## [139] rngWELL_0.10-9              digest_0.6.37               bayesm_3.1-6                permute_0.9-7               numDeriv_2016.8-1.1         bookdown_0.40              \n## [145] Matrix_1.7-0                tzdb_0.4.0                  farver_2.1.2                reshape2_1.4.4              yulab.utils_0.1.7           viridis_0.6.5              \n## [151] DirichletMultinomial_1.47.0 rpart_4.1.23                cachem_1.1.0                polyclip_1.10-7             WGCNA_1.73                  Hmisc_5.1-3                \n## [157] generics_0.1.3              dynamicTreeCut_1.63-1       parallelly_1.38.0           biomformat_1.33.0           pkgload_1.4.0               statmod_1.5.0              \n## [163] impute_1.79.0               huge_1.3.5                  RcppHNSW_0.6.0              ScaledMatrix_1.13.0         carData_3.0-5               minqa_1.2.8                \n## [169] pbapply_1.7-2               glmnet_4.1-8                spam_2.10-0                 utf8_1.2.4                  gtools_3.9.5                shapes_1.2.7               \n## [175] readxl_1.4.3                preprocessCore_1.67.0       inum_1.0-5                  ggsignif_0.6.4              energy_1.7-12               gridExtra_2.3              \n## [181] shiny_1.9.1                 GenomeInfoDbData_1.2.12     rhdf5filters_1.17.0         memoise_2.0.1               rmarkdown_2.28              scales_1.3.0               \n## [187] gld_2.6.6                   stabledist_0.7-2            partykit_1.2-22             future_1.34.0               RANN_2.6.2                  spatstat.data_3.1-2        \n## [193] rstudioapi_0.16.0           cluster_2.1.6               spatstat.utils_3.1-0        hms_1.1.3                   fitdistrplus_1.2-1          munsell_0.5.1              \n## [199] cowplot_1.1.3               colorspace_2.1-1            ellipse_0.5.0               rlang_1.1.4                 quadprog_1.5-8              copula_1.1-4               \n## [205] DelayedMatrixStats_1.27.3   sparseMatrixStats_1.17.2    dotCall64_1.1-1             scuttle_1.15.4              mgcv_1.9-1                  xfun_0.47                  \n## [211] coda_0.19-4.1               e1071_1.7-16                TH.data_1.1-2               posterior_1.6.0             remotes_2.5.0               iterators_1.0.14           \n## [217] rARPACK_0.11-0              abind_1.4-8                 libcoin_1.0-10              treeio_1.29.1               gmp_0.7-5                   Rhdf5lib_1.27.0            \n## [223] DECIPHER_3.1.4              Rdpack_2.6.1                ps_1.8.0                    promises_1.3.0              RSQLite_2.3.7               sandwich_3.1-1             \n## [229] proxy_0.4-27                DelayedArray_0.31.11        Rmpfr_0.9-5                 GO.db_3.20.0                compiler_4.4.1              prettyunits_1.2.0          \n## [235] boot_1.3-31                 distributional_0.5.0        beachmat_2.21.6             rbiom_1.0.3                 listenv_0.9.1               Rcpp_1.0.13                \n## [241] Rttf2pt1_1.3.12             BiocSingular_1.21.4         tensor_1.5                  usethis_3.0.0               progress_1.2.3              BiocParallel_1.39.0        \n## [247] insight_0.20.4              spatstat.random_3.3-2       R6_2.5.1                    rstatix_0.7.2               fastmap_1.2.0               multcomp_1.4-26            \n## [253] vipor_0.4.7                 ROCR_1.0-11                 rsvd_1.0.5                  nnet_7.3-19                 gtable_0.3.5                KernSmooth_2.23-24         \n## [259] miniUI_0.1.1.1              deldir_2.0-4                ggthemes_5.1.0              htmltools_0.5.8.1           RcppParallel_5.1.9          bit64_4.5.2                \n## [265] spatstat.explore_3.3-2      lifecycle_1.0.4             processx_3.8.4              nloptr_2.1.1                callr_3.7.6                 sass_0.4.9                 \n## [271] vctrs_0.6.5                 robustbase_0.99-4           VGAM_1.1-12                 slam_0.1-53                 spatstat.geom_3.3-3         sp_2.1-4                   \n## [277] future.apply_1.11.2         pracma_2.4.4                rvinecopulib_0.6.3.1.1      bslib_0.8.0                 pillar_1.9.0                locfit_1.5-9.10            \n## [283] jsonlite_1.8.9              expm_1.0-0"},{"path":"microbiome-networks.html","id":"microbiome-networks","chapter":"4 Microbiome Networks","heading":"4 Microbiome Networks","text":"Unlike human social networks, simple way observe microbe-microbe\ninteractions – make indirect evidence. One approach uses\npopulation profiles proxy ecological interaction. Taxa often\nco-occur understood cooperative ecological interactions, \ndon’t thought compete niche.Many algorithms designed around intuition, trying go\nbeyond simple co-occurrence instead capture complex types \ndependence. challenge practice ’s hard know method \nuse , since problem unsupervised. Even thorough simulation\nbenchmarking studies available, ’s often obvious well \nsimulation setups match problems interest.","code":""},{"path":"microbiome-networks.html","id":"estimation-1","chapter":"4 Microbiome Networks","heading":"4.1 Estimation","text":"Let’s use simulation benchmark network estimation methods using data \nrounds 1 2 American Gut Project. \nsimulate data known correlation structure taxa-level marginals\nestimated study data. block reads data.’ve estimated zero-inflated negative binomial location-shape-scale\n(ZINBLSS) models taxon, using gaussian copula capture\ndependence. used regression formula ~log(sequencing_depth) + BMI.\ndata structure captures simulator components, can swap\npieces modify form simulator. example, \nwanted, mutate family link function associated \nparticular features.simulated data always SummarizedExperiment. means \nworkflow applied original data can applied simulated one\nwithout changes. Notice also sample defaults drawing samples \ndesign original input experiment (’ll modify using \nnew_data argument minute).","code":"\ndata(amgut)\namgut## class: SummarizedExperiment \n## dim: 45 261 \n## metadata(0):\n## assays(1): counts\n## rownames(45): 326792 181016 ... 364563 301645\n## rowData names(0):\n## colnames(261): 000001879.1076223 000002437.1076448 ... 000002656.1076186 000001582.1076447\n## colData names(167): X.SampleID BarcodeSequence ... Description sequencing_depth\nsim <- setup_simulator(\n  amgut,\n  ~ log(sequencing_depth) + BMI,\n  ~ ZINBLSS()\n) |>\n  estimate(mstop = 100)\nsim## [Marginals]\n## Plan:\n## # A tibble: 6 × 3\n##     feature              family                         link\n##   <gene_id>             <distn>                       <link>\n## 1    326792 ZINBI [mu,sigma,nu] ~log(sequencing_depth) + BMI\n## 2    181016 ZINBI [mu,sigma,nu] ~log(sequencing_depth) + BMI\n## 3    191687 ZINBI [mu,sigma,nu] ~log(sequencing_depth) + BMI\n## 4    326977 ZINBI [mu,sigma,nu] ~log(sequencing_depth) + BMI\n## 5    194648 ZINBI [mu,sigma,nu] ~log(sequencing_depth) + BMI\n## 6    541301 ZINBI [mu,sigma,nu] ~log(sequencing_depth) + BMI\n## \n## Estimates:\n## # A tibble: 3 × 2\n##   feature fit       \n##   <chr>   <list>    \n## 1 326792  <glmbsLSS>\n## 2 181016  <glmbsLSS>\n## 3 191687  <glmbsLSS>\n## ... and 42 additional features.\n## \n## [Dependence]\n## 1 normalCopula with 45 features\n## \n## [Template Data]\n## class: SummarizedExperiment \n## dim: 45 261 \n## metadata(0):\n## assays(1): counts\n## rownames(45): 326792 181016 ... 364563 301645\n## rowData names(0):\n## colnames(261): 000001879.1076223 000002437.1076448 ... 000002656.1076186 000001582.1076447\n## colData names(167): X.SampleID BarcodeSequence ... Description sequencing_depth\nsimulated <- sample(sim)\nsimulated## # A SummarizedExperiment-tibble abstraction: 11,745 × 170\n## # Features=45 | Samples=261 | Assays=counts_1\n##    .feature .sample    counts_1 X.SampleID BarcodeSequence LinkerPrimerSequence CARBOHYDRATE_PER LAST_TRAVEL NONFOODALLERGIES_BEE…¹ ASSIGNED_FROM_GEO RUN_DATE NONFOODALLERGIES_DRUG   AGE TOT_MASS\n##    <chr>    <chr>         <dbl>      <dbl> <fct>           <fct>                           <dbl> <fct>       <fct>                  <fct>             <fct>    <fct>                 <dbl> <fct>   \n##  1 326792   000001879…      257      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n##  2 181016   000001879…       32      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n##  3 191687   000001879…        4      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n##  4 326977   000001879…        0      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n##  5 194648   000001879…      206      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n##  6 541301   000001879…      254      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n##  7 353985   000001879…        0      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n##  8 90487    000001879…      129      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n##  9 352304   000001879…        1      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n## 10 191541   000001879…       17      1879. GAACAAAGAGCG    GTGTGCCAGCMGCCGCGGT…               23 More than … None                   n                 5/20/13  yes                      52 54      \n## # ℹ 35 more rows\n## # ℹ abbreviated name: ¹​NONFOODALLERGIES_BEESTINGS\n## # ℹ 156 more variables: GENERAL_MEDS <fct>, BODY_SITE <fct>, MIGRAINE_FACTOR_2 <fct>, MIGRAINE_FACTOR_3 <fct>, TONSILS_REMOVED <fct>, MIGRAINE_FACTOR_1 <fct>, ELEVATION <fct>,\n## #   PET_LOCATIONS <fct>, FLOSSING_FREQUENCY <fct>, PROTEIN_PER <fct>, CSECTION <fct>, RACE <fct>, COUNTRY_OF_BIRTH <fct>, MACRONUTRIENT_PCT_TOTAL <dbl>, COSMETICS_FREQUENCY <fct>,\n## #   HOST_SUBJECT_ID <fct>, GLUTEN <fct>, ZIP <fct>, LONGITUDE <dbl>, PET_CONTACT <fct>, MIGRAINE_AGGRAVATION <fct>, DIABETES_MEDICATION <fct>, SAMPLE_PLATE <fct>, KEY_SEQ <fct>,\n## #   BODY_PRODUCT <fct>, REGION <fct>, MIGRAINE_FREQUENCY <fct>, MIGRAINE_RELATIVES <fct>, PLANT_PER <dbl>, MIGRAINE_PHOTOPHOBIA <fct>, SITE_SAMPLED <fct>, CURRENT_RESIDENCE_DURATION <fct>,\n## #   COUNTRY <fct>, ANTIBIOTIC_SELECT <fct>, MIGRAINE_NAUSEA <fct>, COMMON_NAME <fct>, FOODALLERGIES_TREENUTS <fct>, MIGRAINE_AURA <fct>, TARGET_GENE <fct>, SEQUENCING_METH <fct>, …"},{"path":"microbiome-networks.html","id":"evaluation-1","chapter":"4 Microbiome Networks","heading":"4.2 Evaluation","text":"Let’s compare marginal count distributions real simulated data.\n’ll need data “long” format able make ggplot2 figure. \npivot_experiment helper can transform original SummarizedExperiment\nobjects way. Notice simulated data tends overestimate \nnumber zeros high-abundance taxa. refine simulator, \nprobably replace zero-inflated negative binomial ordinary negative\nbinomials poorly fitted taxa.learned relationships BMI plausible? can compare scatterplots \nreal simulated data variable. Note , default, \nribbons evaluated along variables, makes jagged\nribbons (neighboring values BMI might different sequencing depth,\npotentially leading quite different predictions). remove artifact, \ncan assume samples exactly sequencing depth.next visualize correlation matrix estimated simulator’s copula\nmodel. pairs taxa highly correlated, \nalso taxa seem higher correlation across large number\ntaxa (e.g., taxon row 34). obvious banding block\nstructure real data, though.pair one high positive correlation. can replace\nselection commented line see one anticorrelated\npairs taxa looks like.","code":"\nbind_rows(\n  real = pivot_experiment(amgut),\n  simulated = pivot_experiment(simulated),\n  .id = \"source\"\n) |>\n  filter(feature %in% rownames(simulated)[1:20]) |>\n  ggplot() +\n  geom_histogram(\n    aes(log(1 + value), fill = source),\n    position = \"identity\", alpha = 0.8\n  ) +\n  facet_wrap(~ reorder(feature, value), scales = \"free\")\nnew_data <- colData(amgut) |>\n  as_tibble() |>\n  mutate(sequencing_depth = 2e4)\nplot(sim, \"BMI\", sample(sim, new_data = new_data), new_data = new_data)\nrho <- copula_parameters(sim)\nheatmap(rho)\n# taxa <- rownames(amgut)[c(33, 43)]\ntaxa <- rownames(amgut)[c(14, 25)]\npivot_experiment(amgut) |>\n  filter(feature %in% taxa) |>\n  pivot_wider(names_from = feature) |>\n  ggplot() +\n  geom_point(aes(log(1 + .data[[taxa[1]]]), log(1 + .data[[taxa[2]]])))"},{"path":"microbiome-networks.html","id":"block-covariance","chapter":"4 Microbiome Networks","heading":"4.3 Block Covariance","text":"Let’s replace current copula correlation structure one block\ndiagonal matrix. example, -diagonal correlations 0.6. can\nuse mutate_correlation swap new correlation matrix earlier\nsimulator.Let’s first look SpiecEasi covariance estimate. variant \ngraphical lasso designed well-adapted microbiome data. good\nnews warn default choices \\(\\lambda\\) large,\ncorrect case. Unfortunately, took get \nanswer, already quite generous allowing fit 10 choices\n\\(\\lambda\\).Let’s instead use Ledoit-Wolf estimator log-transformed data. \nresults make much sense.Since color comparisons difficult evaluate precisely, can also make \nscatterplot comparing different covariance estimators.","code":"\nrho <- c(0.4, .6, 0.8) |>\n  map(~ matrix(., nrow = 15, ncol = 15)) |>\n  Matrix::bdiag() |>\n  as.matrix()\ndiag(rho) <- 1\n\nsimulated <- sim |>\n  mutate_correlation(rho) |>\n  sample()\n\nx <- t(assay(simulated))\nrho_se <- spiec.easi(x, nlambda = 10, pulsar.params = list(rep.num = 1)) |>\n  getOptCov() |>\n  as.matrix() |>\n  cov2cor()\nheatmap(rho_se)\nrho_lw <- CovEst.2003LW(log(1 + x))$S |>\n  cov2cor()\nheatmap(rho_lw)\ndata.frame(truth = c(rho), se = c(rho_se), lw = c(rho_lw)) |>\n  pivot_longer(-truth, values_to = \"estimate\") |>\n  ggplot() +\n  geom_jitter(aes(truth, estimate, col = name), alpha = 0.6, size = 0.4) +\n  geom_abline(slope = 1) +\n  facet_wrap(~name)"},{"path":"microbiome-networks.html","id":"generalization","chapter":"4 Microbiome Networks","heading":"4.4 Generalization","text":"network structures? can use logic evaluate\nseveral network regimes. example, block defines correlation\nmatrices associated scale-free banded structures.example shows , start real template data, ’s \nhard setup benchmarking experiment. ’s generally easier reconfigure\ncomponents existing simulator specify simulation\nsteps scratch. secondary bonus data tend look\nclose real data interest, least deliberate transformations\nneeded establish ground truth.imagine extending example include different data properties\n(sample sizes, variable block sizes correlations, general correlation\nstructure) estimation strategies (alternative transformations \nestimators). Design changes implemented using expand_colData, changes\nsignal can specified mutate_correlation, \nworkflow can used long applies SummarizedExperiment object.","code":"\ndata(example_rho)\nrho_hat <- list()\nfor (r in seq_along(example_rho)) {\n  x <- sim |>\n    mutate_correlation(example_rho[[r]]) |>\n    scDesigner::sample() |>\n    assay()\n\n  rho_se <- spiec.easi(t(x), nlambda = 10, pulsar.params = list(rep.num = 1)) |>\n    getOptCov() |>\n    as.matrix() |>\n    cov2cor()\n  rho_lw <- CovEst.2003LW(log(1 + t(x)))$S |>\n    cov2cor()\n  rho_hat[[names(example_rho)[r]]] <- list(se = rho_se, lw = rho_lw)\n}"},{"path":"batch-effect-correction.html","id":"batch-effect-correction","chapter":"5 Batch Effect Correction","heading":"5 Batch Effect Correction","text":"Integration can subtle exercise. need balance interest seeing\nsimilarities datasets risk making things seem similar\nreally . Simulation can help navigate subtlety letting us\nsee integration methods behave situations know exactly \ndifferent datasets related. note illustrate perspective\nshowing simulation can help horizontal (across batches) \nvertical (across assays) integration. ’ll brief interlude map\nfunction purrr, helpful concisely writing code \notherwise need loops (e.g., batches assays).","code":""},{"path":"batch-effect-correction.html","id":"anaerobic-digestion-data","chapter":"5 Batch Effect Correction","heading":"5.1 Anaerobic Digestion Data","text":"example simultaneously analyzing several batches dataset\nefficiency anaerobic digestion (AD) organic matter. \nessential problem , study, samples collected\nsimultaneously. Small differences across separate runs lead systematic\ndifferences resulting data, can obfuscate interesting\n-group variation experiment intended uncover. \nexample, AD dataset, date sequencing run global effect\nmeasured community composition, can see right away principal\ncomponents plot:can learn general microbiome batch effect integration problem\n(Wang Le Cao, 2020), \ndataset example batch effect correction code comes . \narticle also reviews mechanisms lead batch effects microbiome\ndata, together methods removing effects situations within\nappropriate.batch effect correction, ’s important remove much batch\nvariation possible without accidentally also removing real biological\nvariation present even samples \nsequenced together. sometimes called ``overintegration,’’ \nespecially high risk real biological variation quite subtle,\ne.g., rare cell type one similar prominent one.\nSimulation can help us gauge extent different methods may may\noverintegrate. Since get control -batch \n-biological-condition differences, can see extent \nintegration methods can remove former preserving latter.","code":"\ndata(anaerobic)\npca_batch(anaerobic, facet = FALSE) +\n  scale_color_manual(values = c(\"#191C59\", \"#bc0c3c\")) +\n  labs(\n    col = \"Treatment\",\n    shape = \"Batch\",\n    x = \"PC1 [25.2% Variance Explained]\",\n    y = \"PC2 [16.2% Varianced Explained]\"\n  )"},{"path":"batch-effect-correction.html","id":"simulation-design","chapter":"5 Batch Effect Correction","heading":"5.2 Simulation Design","text":"block estimates candidate simulator. using formula ~ batch + treatment, ’re allowing taxon-wise differences due batch \ntreatment. Note principle, estimate interaction \nbatch treatment (treatment appear stronger batches \nothers). encourage try estimating model; however, visually\nanalyzing output suggests full model tendancy overfit.\nSince data already centered log-ratio transformed, can try \nGaussian marginal model. AD dataset relatively samples\ncompared number features, ’ll use copula ’s designed \nsetting.can simulate fitted model evaluate quality fit using\ncontrast_boxplot. light wrapper ggplot2 code used \ncompare experiments first session, can read definition\n.Exercise Propose create least one visualization can \nused compare contrast simulator real data. conclusions can\ndraw?Solution: many possible answers:Boxplots across taxa different overall abundance levels.Analogous histograms CDF plots, show entire distributions, rather just summarized quantiles.Pair scatterplots, see well bivariate relationships taxa preserved.Dimensionality reduction simulated data, see well matches global structure original data.’ll implement last idea using PCA. contrasted PCA\nplot original data . ’s okay plot seems rotated relative \noiginal plot – PCA unique rotation. main characteristic\n’re looking relative sizes batch treatment effects\nseem reasonaly well-preserved, since types effects \nlater batch effect integration methods must able distinguish.addition visual evaluation, can also perform narrow evaluation using parameter estimations RUV. idea parameter estimation RUV similar simulation data real\ndata. RUV model, estimate treatment effect feature simulation real data sets plotted scatter plot along correlation value two. seen figure good agreement parameter estimations two datasets correlation value 0.66.study risk overintegration, let’s imagine third\ntreatment group relatively fewer samples. type group \ncorrection method might accidentally blend rest, ’s \naggressive. ’ve defined imaginary experiment using data.frame .\ntreatment level 1.8 new one. ’ve supposed 1 -\n3 technical replicates (extraction) biological sample (sample), \nbatch dates .can simulate new design look different new treatment\ngroup seems others. ’s subtle effect, definitely smaller \nbatch effect, also separate enough able preserve .","code":"\nsimulator <- setup_simulator(\n  anaerobic,\n  ~ batch + treatment,\n  ~ GaussianLSS(),\n  copula = copula_adaptive(thr = .1)\n) |>\n  estimate(nu = 0.05, mstop = 100) # lower nu -> stable training\nanaerobic_sim <- sample(simulator)\ncontrast_boxplot(anaerobic, anaerobic_sim)\npca_batch(anaerobic_sim)\nfit_sim <- ruv::RUV4(t(assay(anaerobic_sim)), colData(anaerobic_sim)$treatment, k = 0)\nfit_org <- ruv::RUV4(t(assay(anaerobic)), colData(anaerobic)$treatment, k = 0)\n\n\nbind_cols(org = c(fit_org$betahat), sim = c(fit_sim$betahat)) |>\n  ggplot(aes(org, sim)) +\n  geom_abline(color = \"blue\", lwd = 1.5, lty = 2) +\n  geom_point(size = 2, shape = 16) +\n  theme_classic() +\n  ylab(\"Estimated beta values from simulated data\") +\n  xlab(\"Estimated beta values from real data\") +\n  stat_cor(method = \"pearson\", label.x = -1.4, label.y = 0.7)\ndata(imaginary_design)\nsummary(imaginary_design)##    extraction        batch      treatment           rep           sample   \n##  Min.   :1    09/04/2015:36   Min.   :0.0000   Min.   :1.00   1      :  2  \n##  1st Qu.:1    14/04/2016:36   1st Qu.:0.0000   1st Qu.:1.75   2      :  2  \n##  Median :2    01/07/2016:36   Median :1.0000   Median :2.50   3      :  2  \n##  Mean   :2    14/11/2016:36   Mean   :0.7167   Mean   :2.75   4      :  2  \n##  3rd Qu.:3    21/09/2017:36   3rd Qu.:1.0000   3rd Qu.:4.00   5      :  2  \n##  Max.   :3                    Max.   :1.8000   Max.   :5.00   6      :  2  \n##                                                               (Other):168\np <- list()\nanaerobic_sim <- sample(simulator, new_data = imaginary_design)\np[[\"sim\"]] <- pca_batch(anaerobic_sim)"},{"path":"batch-effect-correction.html","id":"benchmarking","chapter":"5 Batch Effect Correction","heading":"5.3 Benchmarking","text":"’ve defined batch_correct wrapper function implements either \nRUV-III ComBat batch effect correction methods. outputs contrasted\nPCAs . looks like ComBat might somewhat aggressive,\ncausing 1 1.8 treatment groups substantially overlap, RUV\nbit conservative, keeping treatment groups nicely separate. \naside, note conclusion can depend number replicates \ntotal number samples available. ’ve included code generating \nimaginary_design data.frame vignette\nMIGsim package. Can find settings lead either method astray?","code":"\np[[\"ruv\"]] <- pca_batch(batch_correct(anaerobic_sim, \"ruv\"))\np[[\"combat\"]] <- pca_batch(batch_correct(anaerobic_sim, \"combat\"))\nprediction_errors <- function(df) {\n  y_hat <- predict(lda(treatment ~ PC1 + PC2, data = df), type = \"response\")$class\n  table(df$treatment, y_hat)\n}\n\nmap(p, ~ prediction_errors(.$data))## $sim\n##      y_hat\n##        0  1 1.8\n##   0   62 13   0\n##   1   15 56   4\n##   1.8  1 14  15\n## \n## $ruv\n##      y_hat\n##        0  1 1.8\n##   0   70  5   0\n##   1    2 67   6\n##   1.8  0  8  22\n## \n## $combat\n##      y_hat\n##        0  1 1.8\n##   0   65 10   0\n##   1   12 59   4\n##   1.8  1 12  17\nsessionInfo()## R version 4.4.1 Patched (2024-08-21 r87049)\n## Platform: aarch64-apple-darwin20\n## Running under: macOS Sonoma 14.5\n## \n## Matrix products: default\n## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \n## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n## \n## locale:\n## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n## \n## time zone: America/Chicago\n## tzcode source: internal\n## \n## attached base packages:\n##  [1] splines   parallel  stats4    stats     graphics  grDevices utils     datasets  methods   base     \n## \n## other attached packages:\n##  [1] doRNG_1.8.6                     rngtools_1.5.2                  foreach_1.5.2                   lubridate_1.9.3                 readr_2.1.5                    \n##  [6] tidyverse_2.0.0                 ggpubr_0.6.0                    ggrepel_0.9.6                   edgeR_4.3.16                    limma_3.61.10                  \n## [11] ANCOMBC_2.7.0                   stringr_1.5.1                   ks_1.14.3                       tidySummarizedExperiment_1.15.1 ttservice_0.4.1                \n## [16] SimBench_0.99.1                 wesanderson_0.3.7               mia_1.13.36                     MultiAssayExperiment_1.31.5     TreeSummarizedExperiment_2.13.0\n## [21] Biostrings_2.73.1               XVector_0.45.0                  SingleCellExperiment_1.27.2     gamlss_5.4-22                   nlme_3.1-166                   \n## [26] gamlss.dist_6.1-1               gamlss.data_6.0-6               scDesigner_0.0.0.9000           purrr_1.0.2                     MIGsim_0.0.0.9000              \n## [31] tidyr_1.3.1                     tibble_3.2.1                    scico_1.5.0                     pwr_1.3-0                       patchwork_1.3.0                \n## [36] mutoss_0.1-13                   mvtnorm_1.3-1                   mixOmics_6.29.0                 lattice_0.22-6                  MASS_7.3-61                    \n## [41] glue_1.7.0                      ggplot2_3.5.1                   ggdist_3.3.2                    gamboostLSS_2.0-7               mboost_2.9-11                  \n## [46] stabs_0.6-4                     forcats_1.0.0                   dplyr_1.1.4                     SummarizedExperiment_1.35.1     Biobase_2.65.1                 \n## [51] GenomicRanges_1.57.1            GenomeInfoDb_1.41.1             IRanges_2.39.2                  S4Vectors_0.43.2                BiocGenerics_0.51.1            \n## [56] MatrixGenerics_1.17.0           matrixStats_1.4.1               SpiecEasi_1.1.3                 CovTools_0.5.4                 \n## \n## loaded via a namespace (and not attached):\n##   [1] igraph_2.0.3                ica_1.0-3                   plotly_4.10.4               Formula_1.2-5               scater_1.33.4               devtools_2.4.5             \n##   [7] zlibbioc_1.51.1             tidyselect_1.2.1            bit_4.5.0                   doParallel_1.0.17           pspline_1.0-20              blob_1.2.4                 \n##  [13] urlchecker_1.0.1            S4Arrays_1.5.8              png_0.1-8                   plotrix_3.8-4               cli_3.6.3                   CVXR_1.0-14                \n##  [19] pulsar_0.3.11               arrayhelpers_1.1-0          multtest_2.61.0             goftest_1.2-3               textshaping_0.4.0           bluster_1.15.1             \n##  [25] BiocNeighbors_1.99.1        uwot_0.2.2                  curl_5.2.3                  mime_0.12                   evaluate_1.0.0              tidytree_0.4.6             \n##  [31] leiden_0.4.3.1              stringi_1.8.4               backports_1.5.0             desc_1.4.3                  XML_3.99-0.17               lmerTest_3.1-3             \n##  [37] Exact_3.3                   gsl_2.1-8                   httpuv_1.6.15               AnnotationDbi_1.67.0        magrittr_2.0.3              mclust_6.1.1               \n##  [43] ADGofTest_0.3               pcaPP_2.0-5                 rootSolve_1.8.2.4           sctransform_0.4.1           lpSolve_5.6.21              ggbeeswarm_0.7.2           \n##  [49] sessioninfo_1.2.2           DBI_1.2.3                   genefilter_1.87.0           jquerylib_0.1.4             withr_3.0.1                 corpcor_1.6.10             \n##  [55] systemfonts_1.1.0           class_7.3-22                lmtest_0.9-40               sva_3.53.0                  BiocManager_1.30.25         compositions_2.0-8         \n##  [61] htmlwidgets_1.6.4           fs_1.6.4                    labeling_0.4.3              SparseArray_1.5.38          DEoptimR_1.1-3              cellranger_1.1.0           \n##  [67] DESeq2_1.45.3               tidybayes_3.0.7             extrafont_0.19              annotate_1.83.0             lmom_3.0                    flare_1.7.0.1              \n##  [73] reticulate_1.39.0           minpack.lm_1.2-4            geigen_2.3                  zoo_1.8-12                  knitr_1.48                  nnls_1.5                   \n##  [79] UCSC.utils_1.1.0            svUnit_1.0.6                SHT_0.1.8                   timechange_0.3.0            decontam_1.25.0             fansi_1.0.6                \n##  [85] grid_4.4.1                  rhdf5_2.49.0                data.table_1.16.0           ruv_0.9.7.1                 vegan_2.6-8                 RSpectra_0.16-2            \n##  [91] irlba_2.3.5.1               extrafontdb_1.0             DescTools_0.99.56           fastDummies_1.7.4           ellipsis_0.3.2              ade4_1.7-22                \n##  [97] lazyeval_0.2.2              yaml_2.3.10                 survival_3.7-0              scattermore_1.2             crayon_1.5.3                mediation_4.5.0            \n## [103] tensorA_0.36.2.1            phyloseq_1.49.0             RcppAnnoy_0.0.22            RColorBrewer_1.1-3          progressr_0.14.0            later_1.3.2                \n## [109] ggridges_0.5.6              codetools_0.2-20            base64enc_0.1-3             profvis_0.4.0               Seurat_5.1.0                KEGGREST_1.45.1            \n## [115] Rtsne_0.17                  shape_1.4.6.1               randtoolbox_2.0.4           foreign_0.8-87              pkgconfig_2.0.3             xml2_1.3.6                 \n## [121] spatstat.univar_3.0-1       downlit_0.4.4               scatterplot3d_0.3-44        spatstat.sparse_3.1-0       ape_5.8                     viridisLite_0.4.2          \n## [127] xtable_1.8-4                highr_0.11                  car_3.1-2                   fastcluster_1.2.6           plyr_1.8.9                  httr_1.4.7                 \n## [133] rbibutils_2.2.16            tools_4.4.1                 globals_0.16.3              SeuratObject_5.0.2          kde1d_1.0.7                 pkgbuild_1.4.4             \n## [139] broom_1.0.6                 beeswarm_0.4.0              htmlTable_2.4.3             checkmate_2.3.2             rgl_1.3.1                   assertthat_0.2.1           \n## [145] lme4_1.1-35.5               rngWELL_0.10-9              digest_0.6.37               bayesm_3.1-6                permute_0.9-7               numDeriv_2016.8-1.1        \n## [151] bookdown_0.40               Matrix_1.7-0                tzdb_0.4.0                  farver_2.1.2                reshape2_1.4.4              yulab.utils_0.1.7          \n## [157] viridis_0.6.5               DirichletMultinomial_1.47.0 rpart_4.1.23                cachem_1.1.0                polyclip_1.10-7             WGCNA_1.73                 \n## [163] Hmisc_5.1-3                 generics_0.1.3              dynamicTreeCut_1.63-1       parallelly_1.38.0           biomformat_1.33.0           pkgload_1.4.0              \n## [169] statmod_1.5.0               impute_1.79.0               huge_1.3.5                  ragg_1.3.3                  RcppHNSW_0.6.0              ScaledMatrix_1.13.0        \n## [175] carData_3.0-5               minqa_1.2.8                 pbapply_1.7-2               glmnet_4.1-8                spam_2.10-0                 utf8_1.2.4                 \n## [181] gtools_3.9.5                shapes_1.2.7                readxl_1.4.3                preprocessCore_1.67.0       inum_1.0-5                  ggsignif_0.6.4             \n## [187] energy_1.7-12               gridExtra_2.3               shiny_1.9.1                 GenomeInfoDbData_1.2.12     rhdf5filters_1.17.0         memoise_2.0.1              \n## [193] rmarkdown_2.28              scales_1.3.0                gld_2.6.6                   stabledist_0.7-2            partykit_1.2-22             svglite_2.1.3              \n## [199] future_1.34.0               RANN_2.6.2                  spatstat.data_3.1-2         rstudioapi_0.16.0           cluster_2.1.6               spatstat.utils_3.1-0       \n## [205] hms_1.1.3                   fitdistrplus_1.2-1          munsell_0.5.1               cowplot_1.1.3               colorspace_2.1-1            ellipse_0.5.0              \n## [211] rlang_1.1.4                 quadprog_1.5-8              copula_1.1-4                DelayedMatrixStats_1.27.3   sparseMatrixStats_1.17.2    dotCall64_1.1-1            \n## [217] scuttle_1.15.4              mgcv_1.9-1                  xfun_0.47                   coda_0.19-4.1               e1071_1.7-16                TH.data_1.1-2              \n## [223] posterior_1.6.0             remotes_2.5.0               iterators_1.0.14            rARPACK_0.11-0              abind_1.4-8                 libcoin_1.0-10             \n## [229] treeio_1.29.1               gmp_0.7-5                   Rhdf5lib_1.27.0             DECIPHER_3.1.4              Rdpack_2.6.1                ps_1.8.0                   \n## [235] promises_1.3.0              RSQLite_2.3.7               sandwich_3.1-1              proxy_0.4-27                DelayedArray_0.31.11        Rmpfr_0.9-5                \n## [241] GO.db_3.20.0                compiler_4.4.1              prettyunits_1.2.0           boot_1.3-31                 distributional_0.5.0        beachmat_2.21.6            \n## [247] rbiom_1.0.3                 listenv_0.9.1               Rcpp_1.0.13                 Rttf2pt1_1.3.12             BiocSingular_1.21.4         tensor_1.5                 \n## [253] usethis_3.0.0               progress_1.2.3              BiocParallel_1.39.0         insight_0.20.4              spatstat.random_3.3-2       R6_2.5.1                   \n## [259] rstatix_0.7.2               fastmap_1.2.0               multcomp_1.4-26             vipor_0.4.7                 ROCR_1.0-11                 rsvd_1.0.5                 \n## [265] nnet_7.3-19                 gtable_0.3.5                KernSmooth_2.23-24          miniUI_0.1.1.1              deldir_2.0-4                ggthemes_5.1.0             \n## [271] htmltools_0.5.8.1           RcppParallel_5.1.9          bit64_4.5.2                 spatstat.explore_3.3-2      lifecycle_1.0.4             processx_3.8.4             \n## [277] nloptr_2.1.1                callr_3.7.6                 sass_0.4.9                  vctrs_0.6.5                 robustbase_0.99-4           VGAM_1.1-12                \n## [283] slam_0.1-53                 spatstat.geom_3.3-3         sp_2.1-4                    future.apply_1.11.2         pracma_2.4.4                rvinecopulib_0.6.3.1.1     \n## [289] bslib_0.8.0                 pillar_1.9.0                locfit_1.5-9.10             jsonlite_1.8.9              expm_1.0-0"},{"path":"vertical-integration.html","id":"vertical-integration","chapter":"6 Vertical Integration","heading":"6 Vertical Integration","text":"horizontal integration, many datasets, features.\ndiffer gathered different times. contrast, \nvertical integration, instead many datasets samples.\ndiffer measure different aspects samples. goal \nsituation remove differences across datasets, like \nhorizontal integration, instead clarify relationships across sources.One important question often arises vertical integration – \ndata even alignable? , effort look relationships across\ndatasets, might accidentally miss interesting variation exists\nwithin individual assays. technologies measuring different\nthings, might better simply analyzing data separately. help us\ngauge setting might , can simulate data know \nshouldn’t align sources. integration methods giving similar\noutputs give simulated data, cautious.ways dataset might ``alignable.’’ \ngeneral reason may latent sources variation common\nsources. simpler reason something influenced one\nassay substantially (e.g., disease state) might influence much.\nLet’s see integration method might work setting.","code":""},{"path":"vertical-integration.html","id":"icu-dataset","chapter":"6 Vertical Integration","heading":"6.1 ICU Dataset","text":"’ll work ICU sepsis dataset previously studied Haak et al.\n(2021) documented within \nvignette\nMOFA package. three datasets 16S bacterial, fungal, \nVirome assays, applied different healthy sepsis patient populations.\nMoreover, participants course antibiotics others \n. question either sepsis, antibiotics, interaction\naffects microbiome viewed three assays. data printed\n, already filtered CLR transformed following MOFA\nvignette.can simultaneously analyze data sources using block sPLS-DA. \nmulti-assay version analysis saw previous session.\nexper_splsda light wrapper mixOmics function call, \ncan read\n.\noutput plot shows assay differs across groups, \nquantitatively summarized high estimated weights category\nestimated PLS directions.","code":"\ndata(icu)\nicu## $Bacteria\n## # A SummarizedExperiment-tibble abstraction: 10,260 × 19\n## # Features=180 | Samples=57 | Assays=clr\n##    .feature   .sample    clr   Age Sexs  Diagnosis Category Penicillins Cephalosporins Carbapenems Macrolides Aminoglycosides Quinolones Co_trimoxazole Metronidazole Vancomycin Acetate Propionate\n##    <chr>      <chr>    <dbl> <int> <chr> <chr>     <chr>    <lgl>       <lgl>          <lgl>       <lgl>      <lgl>           <lgl>      <lgl>          <lgl>         <lgl>        <dbl>      <dbl>\n##  1 Acidamino… TKI_F1  -0.717    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  2 Actinomyc… TKI_F1  -0.717    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  3 Adlercreu… TKI_F1  -0.717    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  4 Agathobac… TKI_F1  -0.717    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  5 Akkermans… TKI_F1   1.68     89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  6 Alistipes  TKI_F1  10.9      89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  7 Allisonel… TKI_F1  -0.717    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  8 Alloprevo… TKI_F1  -0.717    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  9 Anaerofil… TKI_F1  -0.717    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n## 10 Anaerofus… TKI_F1  -0.717    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n## # ℹ 40 more rows\n## # ℹ 1 more variable: Butyrate <dbl>\n## \n## $Fungi\n## # A SummarizedExperiment-tibble abstraction: 1,026 × 19\n## # Features=18 | Samples=57 | Assays=clr\n##    .feature   .sample    clr   Age Sexs  Diagnosis Category Penicillins Cephalosporins Carbapenems Macrolides Aminoglycosides Quinolones Co_trimoxazole Metronidazole Vancomycin Acetate Propionate\n##    <chr>      <chr>    <dbl> <int> <chr> <chr>     <chr>    <lgl>       <lgl>          <lgl>       <lgl>      <lgl>           <lgl>      <lgl>          <lgl>         <lgl>        <dbl>      <dbl>\n##  1 Agaricus   TKI_F1  -1.21     89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  2 Aspergill… TKI_F1   6.63     89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  3 Aureobasi… TKI_F1  -4.25     89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  4 Candida    TKI_F1   8.16     89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  5 Cladospor… TKI_F1   1.05     89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  6 Debaryomy… TKI_F1  -0.540    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  7 Dipodascus TKI_F1  -1.86     89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  8 Filobasid… TKI_F1  -1.21     89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  9 Issatchen… TKI_F1   0.141    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n## 10 Malassezia TKI_F1   0.764    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n## # ℹ 350 more rows\n## # ℹ 1 more variable: Butyrate <dbl>\n## \n## $Viruses\n## # A SummarizedExperiment-tibble abstraction: 2,394 × 19\n## # Features=42 | Samples=57 | Assays=clr\n##    .feature   .sample    clr   Age Sexs  Diagnosis Category Penicillins Cephalosporins Carbapenems Macrolides Aminoglycosides Quinolones Co_trimoxazole Metronidazole Vancomycin Acetate Propionate\n##    <chr>      <chr>    <dbl> <int> <chr> <chr>     <chr>    <lgl>       <lgl>          <lgl>       <lgl>      <lgl>           <lgl>      <lgl>          <lgl>         <lgl>        <dbl>      <dbl>\n##  1 Acidovora… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  2 Acinetoba… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  3 Aeromonas… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  4 Anellovir… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  5 Arthrobac… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  6 Bacillus … TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  7 Bacteroid… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  8 Bacteroid… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n##  9 Brochothr… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n## 10 Burkholde… TKI_F1  -0.602    89 Fema… Sepsis, … Sepsis   FALSE       FALSE          FALSE       FALSE      TRUE            TRUE       FALSE          FALSE         TRUE          6.44       2.40\n## # ℹ 32 more rows\n## # ℹ 1 more variable: Butyrate <dbl>\nfit <- exper_splsda(icu)\nplotIndiv(fit)\nfit$weights##              comp1     comp2\n## Bacteria 0.8580402 0.8191458\n## Fungi    0.6513668 0.4845247\n## Viruses  0.6118091 0.8047067"},{"path":"vertical-integration.html","id":"interlude-using-map","chapter":"6 Vertical Integration","heading":"6.2 Interlude: Using map","text":"examples , ’ll find helpful use function map \npurrr package. function gives one-line replacement simple -loops;\nanalogous list comprehensions python. can useful many places\nbesides topic tutorial. example, want convert \nvector c(1, 2, 3) c(1, 4, 9), can use map:~ notation shorthand defining function, . represents\ncurrent vector element. generally, can apply map lists. \nline update list 1 added element.Exercise: test understanding, can write map computes \n*mean \nvector list x ? mean 10 smallest elements?","code":"\nmap(1:3, ~ .^2)## [[1]]\n## [1] 1\n## \n## [[2]]\n## [1] 4\n## \n## [[3]]\n## [1] 9\nmap(list(a = 1, b = 2, c = 3), ~ . + 1)## $a\n## [1] 2\n## \n## $b\n## [1] 3\n## \n## $c\n## [1] 4\nx <- list(a = rnorm(100), b = rnorm(100, 1))\nmap(x, mean)## $a\n## [1] 0.1177328\n## \n## $b\n## [1] 1.128995\nmap(x, ~ mean(sort(.)[1:10]))## $a\n## [1] -1.920247\n## \n## $b\n## [1] -0.8639795"},{"path":"vertical-integration.html","id":"simulation-question","chapter":"6 Vertical Integration","heading":"6.3 Simulation Question","text":"output looked 16S community composition \nrelated disease antibiotics groups? Since integrative analysis prioritizes\nsimilarities across sources, expect mask real differences\nfungal virus data well. can use simulation gauge extent\nmasking.first step train simulator. ’re just learning four different\nsetes parameters four observed groups. nuanced\nlearning separate effects sepsis antibiotics, enough\nillustration. used map estimate simulator assay \nicu list.far, haven’t tried removing relationships present 16S assay,\nindeed integrative analysis output simulated data looks\ncomparable original study.Exercise: Modify simulator 16S group longer depends\ndisease cateogry. allow us study integrative analysis\noutput changes data alignable.Solution: need define new link longer depends Category. One solution\nmodify existing simulator place using mutate.Since modifying taxa, simpler solution just define \nnew simulator scratch.","code":"\nsimulator <- map(\n  icu,\n  ~ setup_simulator(., ~Category, ~ GaussianLSS()) |>\n    estimate(nu = 0.05)\n)\nicu_sim <- join_copula(simulator, copula_adaptive()) |>\n  sample() |>\n  split_assays()\n\nfit_sim <- exper_splsda(icu_sim)\nplotIndiv(fit_sim)\nfit$weights##              comp1     comp2\n## Bacteria 0.8580402 0.8191458\n## Fungi    0.6513668 0.4845247\n## Viruses  0.6118091 0.8047067\nnull_simulator <- simulator\n# fill this in\n# null_simulator[[1]] <- ???\nnull_simulator[[1]] <- simulator[[1]] |>\n  mutate(1:180, link = ~1) |>\n  estimate(nu = 0.05)\nnull_simulator[[1]] <- setup_simulator(icu[[1]], ~1, ~ GaussianLSS()) |>\n  estimate(nu = 0.05)"},{"path":"vertical-integration.html","id":"simulation-results","chapter":"6 Vertical Integration","heading":"6.4 Simulation Results","text":"can rerun integrative analysis using modified simulator. Somewhat\nsurprisingly, disease association bacteria group hasn’t erased.\nartifact integration. assays associations \ndisease group, since method encourages outputs across tables \nconsistent one another, artificially introduced structure \nbacteria visualization (even quite weak.) Nonetheless, still\nobserve large dropoff weight bacterial table. , seems\nminor deterioration group separations fungal virus\ncommunities, component weights higher work \nfungal virus assays. Altogether, suggests may want check\ntable-level associations response variable, especially \nintegration outputs ambiguous. case, might able increase\npower focusing class-associated assays. Nonetheless, block\nsPLS-DA also seems relatively robust – considering dramatic change \nmicrobiome table, output remaining tables still surfaces interesting\nrelationships.","code":"\nicu_sim <- join_copula(null_simulator, copula_adaptive()) |>\n  sample() |>\n  split_assays()\nfit_null <- exper_splsda(icu_sim)\nplotIndiv(fit)\nfit_null$weights##              comp1     comp2\n## Bacteria 0.6658170 0.6571177\n## Fungi    0.7479665 0.6797712\n## Viruses  0.7015960 0.7929047"},{"path":"vertical-integration.html","id":"alignability","chapter":"6 Vertical Integration","heading":"6.5 Alignability","text":"canonical correlations compare real data reference\nnull? First, can compute CCA canonical correlations using real\nBacteria Virus data.Next, define reference null compute canonical correlations ten\nreplicates null. define reference null, zero \ncorrelations across tables. draw 100 samples resulting\ndistribution compute canonical correlations .help later visualization, combine real reference\ncanonical correlations tidy data.frame. visualized hidden\nchunk – want see source code, can review \n.","code":"\nmerged <- simulator[c(1, 3)] |>\n  join_copula(copula_adaptive(thr = 0.01))\n\nxy <- sample(merged) |>\n  assay() |>\n  t()\nix <- map(icu, rownames)\ncca_result <- rcc(xy[, ix[[1]]], xy[, ix[[3]]], method = \"shrinkage\")\nrho_null <- copula_parameters(merged)\ndimnames(rho_null) <- list(colnames(xy), colnames(xy))\nrho_null[ix[[1]], ix[[3]]] <- 0\nrho_null[ix[[3]], ix[[1]]] <- 0\n\nnull_cancor <- merged |>\n  mutate_correlation(rho_null)\n\nB <- 100\ncancors <- list()\nfor (b in seq_len(B)) {\n  xy_null <- sample(null_cancor) |>\n    assay() |>\n    t()\n\n  cancors[[glue(\"sim_{b}\")]] <- rcc(xy_null[, ix[[1]]], xy_null[, ix[[3]]], method = \"shrinkage\")$cor\n}\ncancors[[\"true\"]] <- cca_result$cor\ncontrast_data <- bind_rows(cancors, .id = \"rep\") |>\n  pivot_longer(-rep, names_to = \"loading\") |>\n  mutate(\n    source = grepl(\"true\", rep),\n    loading = as.integer(loading)\n  )\nhead(contrast_data)## # A tibble: 6 × 4\n##   rep   loading value source\n##   <chr>   <int> <dbl> <lgl> \n## 1 sim_1       1 0.913 FALSE \n## 2 sim_1       2 0.880 FALSE \n## 3 sim_1       3 0.848 FALSE \n## 4 sim_1       4 0.826 FALSE \n## 5 sim_1       5 0.815 FALSE \n## 6 sim_1       6 0.797 FALSE\nsessionInfo()## R version 4.4.1 Patched (2024-08-21 r87049)\n## Platform: aarch64-apple-darwin20\n## Running under: macOS Sonoma 14.5\n## \n## Matrix products: default\n## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \n## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n## \n## locale:\n## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n## \n## time zone: America/Chicago\n## tzcode source: internal\n## \n## attached base packages:\n##  [1] splines   parallel  stats4    stats     graphics  grDevices utils     datasets  methods   base     \n## \n## other attached packages:\n##  [1] doRNG_1.8.6                     rngtools_1.5.2                  foreach_1.5.2                   lubridate_1.9.3                 readr_2.1.5                    \n##  [6] tidyverse_2.0.0                 ggpubr_0.6.0                    ggrepel_0.9.6                   edgeR_4.3.16                    limma_3.61.10                  \n## [11] ANCOMBC_2.7.0                   stringr_1.5.1                   ks_1.14.3                       tidySummarizedExperiment_1.15.1 ttservice_0.4.1                \n## [16] SimBench_0.99.1                 wesanderson_0.3.7               mia_1.13.36                     MultiAssayExperiment_1.31.5     TreeSummarizedExperiment_2.13.0\n## [21] Biostrings_2.73.1               XVector_0.45.0                  SingleCellExperiment_1.27.2     gamlss_5.4-22                   nlme_3.1-166                   \n## [26] gamlss.dist_6.1-1               gamlss.data_6.0-6               scDesigner_0.0.0.9000           purrr_1.0.2                     MIGsim_0.0.0.9000              \n## [31] tidyr_1.3.1                     tibble_3.2.1                    scico_1.5.0                     pwr_1.3-0                       patchwork_1.3.0                \n## [36] mutoss_0.1-13                   mvtnorm_1.3-1                   mixOmics_6.29.0                 lattice_0.22-6                  MASS_7.3-61                    \n## [41] glue_1.7.0                      ggplot2_3.5.1                   ggdist_3.3.2                    gamboostLSS_2.0-7               mboost_2.9-11                  \n## [46] stabs_0.6-4                     forcats_1.0.0                   dplyr_1.1.4                     SummarizedExperiment_1.35.1     Biobase_2.65.1                 \n## [51] GenomicRanges_1.57.1            GenomeInfoDb_1.41.1             IRanges_2.39.2                  S4Vectors_0.43.2                BiocGenerics_0.51.1            \n## [56] MatrixGenerics_1.17.0           matrixStats_1.4.1               SpiecEasi_1.1.3                 CovTools_0.5.4                 \n## \n## loaded via a namespace (and not attached):\n##   [1] svUnit_1.0.6                nnls_1.5                    DBI_1.2.3                   bslib_0.8.0                 lpSolve_5.6.21              httr_1.4.7                 \n##   [7] BiocParallel_1.39.0         prettyunits_1.2.0           yulab.utils_0.1.7           gsl_2.1-8                   sparseMatrixStats_1.17.2    posterior_1.6.0            \n##  [13] spatstat.geom_3.3-3         BiocBaseUtils_1.7.3         pillar_1.9.0                R6_2.5.1                    boot_1.3-31                 mime_0.12                  \n##  [19] lmom_3.0                    reticulate_1.39.0           uwot_0.2.2                  Rttf2pt1_1.3.12             viridis_0.6.5               genefilter_1.87.0          \n##  [25] Rhdf5lib_1.27.0             DECIPHER_3.1.4              libcoin_1.0-10              vegan_2.6-8                 pspline_1.0-20              ROCR_1.0-11                \n##  [31] CVXR_1.0-14                 Hmisc_5.1-3                 mediation_4.5.0             ADGofTest_0.3               parallelly_1.38.0           rbibutils_2.2.16           \n##  [37] mgcv_1.9-1                  polyclip_1.10-7             beachmat_2.21.6             huge_1.3.5                  htmltools_0.5.8.1           fansi_1.0.6                \n##  [43] e1071_1.7-16                remotes_2.5.0               car_3.1-2                   scuttle_1.15.4              spatstat.utils_3.1-0        scatterplot3d_0.3-44       \n##  [49] rvinecopulib_0.6.3.1.1      rpart_4.1.23                fitdistrplus_1.2-1          goftest_1.2-3               tidyselect_1.2.1            RSQLite_2.3.7              \n##  [55] cowplot_1.1.3               GenomeInfoDbData_1.2.12     utf8_1.2.4                  ScaledMatrix_1.13.0         downlit_0.4.4               scattermore_1.2            \n##  [61] sessioninfo_1.2.2           spatstat.data_3.1-2         gridExtra_2.3               fs_1.6.4                    sctransform_0.4.1           RColorBrewer_1.1-3         \n##  [67] future.apply_1.11.2         RcppHNSW_0.6.0              vipor_0.4.7                 stabledist_0.7-2            Rtsne_0.17                  DelayedMatrixStats_1.27.3  \n##  [73] lazyeval_0.2.2              sass_0.4.9                  scales_1.3.0                carData_3.0-5               munsell_0.5.1               ellipse_0.5.0              \n##  [79] treeio_1.29.1               profvis_0.4.0               pracma_2.4.4                sva_3.53.0                  labeling_0.4.3              KEGGREST_1.45.1            \n##  [85] promises_1.3.0              copula_1.1-4                shape_1.4.6.1               rhdf5filters_1.17.0         zoo_1.8-12                  locfit_1.5-9.10            \n##  [91] DelayedArray_0.31.11        RSpectra_0.16-2             multcomp_1.4-26             assertthat_0.2.1            tools_4.4.1                 ape_5.8                    \n##  [97] scater_1.33.4               processx_3.8.4              insight_0.20.4              shiny_1.9.1                 rlang_1.1.4                 generics_0.1.3             \n## [103] BiocSingular_1.21.4         ggridges_0.5.6              extrafont_0.19              evaluate_1.0.0              fastcluster_1.2.6           reshape2_1.4.4             \n## [109] devtools_2.4.5              plotrix_3.8-4               arrayhelpers_1.1-0          expm_1.0-0                  colorspace_2.1-1            randtoolbox_2.0.4          \n## [115] ellipsis_0.3.2              data.table_1.16.0           withr_3.0.1                 xtable_1.8-4                plyr_1.8.9                  lme4_1.1-35.5              \n## [121] systemfonts_1.1.0           mclust_6.1.1                httpuv_1.6.15               rmarkdown_2.28              robustbase_0.99-4           broom_1.0.6                \n## [127] deldir_2.0-4                GO.db_3.20.0                sandwich_3.1-1              rhdf5_2.49.0                tensor_1.5                  vctrs_0.6.5                \n## [133] lifecycle_1.0.4             readxl_1.4.3                ragg_1.3.3                  proxy_0.4-27                codetools_0.2-20            fastDummies_1.7.4          \n## [139] highr_0.11                  phyloseq_1.49.0             future_1.34.0               DESeq2_1.45.3               progress_1.2.3              pkgload_1.4.0              \n## [145] ruv_0.9.7.1                 cellranger_1.1.0            jquerylib_0.1.4             Rcpp_1.0.13                 rngWELL_0.10-9              pcaPP_2.0-5                \n## [151] rstudioapi_0.16.0           stringi_1.8.4               VGAM_1.1-12                 hms_1.1.3                   pbapply_1.7-2               minqa_1.2.8                \n## [157] cachem_1.1.0                multtest_2.61.0             Rmpfr_0.9-5                 BiocManager_1.30.25         tidytree_0.4.6              listenv_0.9.1              \n## [163] urlchecker_1.0.1            plotly_4.10.4               WGCNA_1.73                  pkgbuild_1.4.4              bookdown_0.40               SparseArray_1.5.38         \n## [169] htmlwidgets_1.6.4           Formula_1.2-5               DescTools_0.99.56           class_7.3-22                memoise_2.0.1               geigen_2.3                 \n## [175] crayon_1.5.3                Seurat_5.1.0                S4Arrays_1.5.8              xml2_1.3.6                  preprocessCore_1.67.0       Exact_3.3                  \n## [181] UCSC.utils_1.1.0            png_0.1-8                   progressr_0.14.0            shapes_1.2.7                tzdb_0.4.0                  ggthemes_5.1.0             \n## [187] fastmap_1.2.0               coda_0.19-4.1               decontam_1.25.0             inum_1.0-5                  pkgconfig_2.0.3             cli_3.6.3                  \n## [193] beeswarm_0.4.0              energy_1.7-12               ps_1.8.0                    gld_2.6.6                   ggsignif_0.6.4              nnet_7.3-19                \n## [199] DirichletMultinomial_1.47.0 lmtest_0.9-40               textshaping_0.4.0           usethis_3.0.0               RcppAnnoy_0.0.22            lmerTest_3.1-3             \n## [205] slam_0.1-53                 DEoptimR_1.1-3              timechange_0.3.0            SHT_0.1.8                   viridisLite_0.4.2           foreign_0.8-87             \n## [211] blob_1.2.4                  impute_1.79.0               annotate_1.83.0             XML_3.99-0.17               numDeriv_2016.8-1.1         globals_0.16.3             \n## [217] ggbeeswarm_0.7.2            permute_0.9-7               knitr_1.48                  gmp_0.7-5                   tensorA_0.36.2.1            ica_1.0-3                  \n## [223] spam_2.10-0                 compiler_4.4.1              RcppParallel_5.1.9          extrafontdb_1.0             grid_4.4.1                  bit_4.5.0                  \n## [229] BiocNeighbors_1.99.1        sp_2.1-4                    digest_0.6.37               tidybayes_3.0.7             quadprog_1.5-8              bayesm_3.1-6               \n## [235] irlba_2.3.5.1               leiden_0.4.3.1              glmnet_4.1-8                rgl_1.3.1                   spatstat.random_3.3-2       zlibbioc_1.51.1            \n## [241] dotCall64_1.1-1             statmod_1.5.0               rsvd_1.0.5                  igraph_2.0.3                nloptr_2.1.1                yaml_2.3.10                \n## [247] biomformat_1.33.0           later_1.3.2                 backports_1.5.0             rstatix_0.7.2               AnnotationDbi_1.67.0        compositions_2.0-8         \n## [253] miniUI_0.1.1.1              gtable_0.3.5                abind_1.4-8                 rARPACK_0.11-0              xfun_0.47                   ade4_1.7-22                \n## [259] flare_1.7.0.1               curl_5.2.3                  callr_3.7.6                 rootSolve_1.8.2.4           doParallel_1.0.17           dynamicTreeCut_1.63-1      \n## [265] KernSmooth_2.23-24          survival_3.7-0              jsonlite_1.8.9              magrittr_2.0.3              desc_1.4.3                  svglite_2.1.3              \n## [271] base64enc_0.1-3             iterators_1.0.14            TH.data_1.1-2               spatstat.univar_3.0-1       rbiom_1.0.3                 minpack.lm_1.2-4           \n## [277] Matrix_1.7-0                SeuratObject_5.0.2          distributional_0.5.0        partykit_1.2-22             kde1d_1.0.7                 checkmate_2.3.2            \n## [283] gtools_3.9.5                htmlTable_2.4.3             spatstat.sparse_3.1-0       RANN_2.6.2                  bluster_1.15.1              spatstat.explore_3.3-2     \n## [289] bit64_4.5.2                 cluster_2.1.6               pulsar_0.3.11               Rdpack_2.6.1                farver_2.1.2                corpcor_1.6.10"},{"path":"references.html","id":"references","chapter":"References","heading":"References","text":"","code":""}]
