<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Batch Effect Correction | Simulation for Microbiome Analysis</title>
<meta name="author" content="Kris Sankaran, Saritha Kodikara, Jingyi Jessica Li, and Kim-Anh Lê Cao">
<meta name="description" content="Integration can be a subtle exercise. We need to balance our interest in seeing similarities between datasets with the risk of making things seem more similar than they really are. Simulation can...">
<meta name="generator" content="bookdown 0.40 with bs4_book()">
<meta property="og:title" content="Chapter 5 Batch Effect Correction | Simulation for Microbiome Analysis">
<meta property="og:type" content="book">
<meta property="og:url" content="https://krisrs1128.github.io/microbiome-simulation/batch-effect-correction.html">
<meta property="og:description" content="Integration can be a subtle exercise. We need to balance our interest in seeing similarities between datasets with the risk of making things seem more similar than they really are. Simulation can...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Batch Effect Correction | Simulation for Microbiome Analysis">
<meta name="twitter:description" content="Integration can be a subtle exercise. We need to balance our interest in seeing similarities between datasets with the risk of making things seem more similar than they really are. Simulation can...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Simulation for Microbiome Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="simulating-differential-abundance.html"><span class="header-section-number">2</span> Simulating Differential Abundance</a></li>
<li><a class="" href="multivariate-power-analysis.html"><span class="header-section-number">3</span> Multivariate Power Analysis</a></li>
<li><a class="" href="microbiome-networks.html"><span class="header-section-number">4</span> Microbiome Networks</a></li>
<li><a class="active" href="batch-effect-correction.html"><span class="header-section-number">5</span> Batch Effect Correction</a></li>
<li><a class="" href="vertical-integration.html"><span class="header-section-number">6</span> Vertical Integration</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="batch-effect-correction" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Batch Effect Correction<a class="anchor" aria-label="anchor" href="#batch-effect-correction"><i class="fas fa-link"></i></a>
</h1>
<p>Integration can be a subtle exercise. We need to balance our interest in seeing
similarities between datasets with the risk of making things seem more similar
than they really are. Simulation can help navigate this subtlety by letting us
see how integration methods would behave in situations where we know exactly how
the different datasets are related. This note will illustrate this perspective
by showing how simulation can help with both horizontal (across batches) and
vertical (across assays) integration. We’ll have a brief interlude on the <code>map</code>
function in the <code>purrr</code>, which is helpful for concisely writing code that would
otherwise need for loops (e.g., over batches or assays).</p>
<div id="anaerobic-digestion-data" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Anaerobic Digestion Data<a class="anchor" aria-label="anchor" href="#anaerobic-digestion-data"><i class="fas fa-link"></i></a>
</h2>
<p>This example is about simultaneously analyzing several batches in a dataset
about the efficiency of anaerobic digestion (AD) of organic matter. The
essential problem is that, in this study, the samples could not be collected
simultaneously. Small differences across separate runs could lead to systematic
differences in the resulting data, which can obfuscate the more interesting
between-group variation that the experiment was intended to uncover. For
example, in the AD dataset, the date of the sequencing run has a global effect
on measured community composition, which we can see right away from a principal
components plot:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">anaerobic</span><span class="op">)</span></span>
<span><span class="fu">pca_batch</span><span class="op">(</span><span class="va">anaerobic</span>, facet <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#191C59"</span>, <span class="st">"#bc0c3c"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    col <span class="op">=</span> <span class="st">"Treatment"</span>,</span>
<span>    shape <span class="op">=</span> <span class="st">"Batch"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"PC1 [25.2% Variance Explained]"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"PC2 [16.2% Varianced Explained]"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="simulation_for_microbiome_files/figure-html/pca-anaerobic-1.png" width="672"></div>
<p>You can learn more about the general microbiome batch effect integration problem
in <a href="https://doi.org/10.1093/bib/bbz105">(Wang and Le Cao, 2020)</a>, which is where
this dataset example and the batch effect correction code below comes from. The
article also reviews mechanisms that could lead to batch effects in microbiome
data, together with methods for removing these effects and the situations within
which they are most appropriate.</p>
<p>In batch effect correction, it’s important to remove as much of the batch
variation as possible without accidentally also removing the real biological
variation that would have been present even if all the samples had been
sequenced together. This is sometimes called ``overintegration,’’ and this is an
especially high risk if some of the real biological variation is quite subtle,
e.g., a rare cell type or one that is very similar to a more prominent one.
Simulation can help us gauge the extent to which different methods may or may
not overintegrate. Since we get to control the between-batch and and
between-biological-condition differences, we can see the extent to which
integration methods can remove the former while preserving the latter.</p>
</div>
<div id="simulation-design" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Simulation Design<a class="anchor" aria-label="anchor" href="#simulation-design"><i class="fas fa-link"></i></a>
</h2>
<p>The block below estimates a candidate simulator. By using the formula <code>~ batch + treatment</code>, we’re allowing for taxon-wise differences due to batch and
treatment. Note that in principle, we could estimate an interaction between
batch and treatment (the treatment could appear stronger in some batches than
others). I encourage you to try estimating that model; however, visually
analyzing the output suggests that this full model has a tendancy to overfit.
Since the data have already been centered log-ratio transformed, we can try out
a Gaussian marginal model. The AD dataset has relatively few samples
compared to the number of features, so we’ll use a copula that’s designed for
this setting.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/setup_simulator.html">setup_simulator</a></span><span class="op">(</span></span>
<span>  <span class="va">anaerobic</span>,</span>
<span>  <span class="op">~</span> <span class="va">batch</span> <span class="op">+</span> <span class="va">treatment</span>,</span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gamboostLSS/man/families.html">GaussianLSS</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  copula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/copula_adaptive.html">copula_adaptive</a></span><span class="op">(</span>thr <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">estimate</span><span class="op">(</span>nu <span class="op">=</span> <span class="fl">0.05</span>, mstop <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="co"># lower nu -&gt; stable training</span></span></code></pre></div>
<p>We can simulate from the fitted model and evaluate the quality of our fit using
<code>contrast_boxplot</code>. This is a light wrapper of the ggplot2 code we used to
compare experiments from our first session, and you can read its definition
<a href="https://github.com/krisrs1128/intro-to-simulation/blob/10fa498aea952684204b2f15c387a7983c30626d/MIGsim/R/plot.R#L26">here</a>.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">anaerobic_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">)</span></span>
<span><span class="fu">contrast_boxplot</span><span class="op">(</span><span class="va">anaerobic</span>, <span class="va">anaerobic_sim</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="simulation_for_microbiome_files/figure-html/eval-anaerobic-1.png" width="672"></div>
<p><strong>Exercise</strong> Propose and create at least one other visualization that can be
used to compare and contrast the simulator with real data. What conclusions can
you draw?</p>
<p><strong>Solution</strong>: There are many possible answers:</p>
<ul>
<li>Boxplots across taxa with different overall abundance levels.</li>
<li>Analogous histograms or CDF plots, to show the entire distributions, rather than just summarized quantiles.</li>
<li>Pair scatterplots, to see how well the bivariate relationships between taxa are preserved.</li>
<li>Dimensionality reduction on the simulated data, to see how well it matches global structure in the original data.</li>
</ul>
<p>We’ll implement the last idea using PCA. This should be contrasted with the PCA
plot on the original data above. It’s okay if the plot seems rotated relative to
the oiginal plot – PCA is only unique up to rotation. The main characteristic
we’re looking for is that the relative sizes of the batch and treatment effects
seem reasonaly well-preserved, since these will be the types of effects that our
later batch effect integration methods must be able to distinguish.</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pca_batch</span><span class="op">(</span><span class="va">anaerobic_sim</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-26-1.png" width="672"></div>
<p>In addition to visual evaluation, we can also perform a narrow evaluation using the parameter estimations from RUV. The idea here is that the parameter estimation from RUV should be similar for simulation data and real
data. In the RUV model, we estimate the treatment effect for each feature in simulation and real data sets and are plotted in the scatter plot along with the correlation value between the two. As seen in the figure there is good agreement with the parameter estimations from the two datasets with a correlation value of 0.66.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_sim</span> <span class="op">&lt;-</span> <span class="fu">ruv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ruv/man/RUV4.html">RUV4</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span><span class="op">(</span><span class="va">anaerobic_sim</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span><span class="op">(</span><span class="va">anaerobic_sim</span><span class="op">)</span><span class="op">$</span><span class="va">treatment</span>, k <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">fit_org</span> <span class="op">&lt;-</span> <span class="fu">ruv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ruv/man/RUV4.html">RUV4</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span><span class="op">(</span><span class="va">anaerobic</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">colData</a></span><span class="op">(</span><span class="va">anaerobic</span><span class="op">)</span><span class="op">$</span><span class="va">treatment</span>, k <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span>org <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fit_org</span><span class="op">$</span><span class="va">betahat</span><span class="op">)</span>, sim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fit_sim</span><span class="op">$</span><span class="va">betahat</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">org</span>, <span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"blue"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, shape <span class="op">=</span> <span class="fl">16</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Estimated beta values from simulated data"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Estimated beta values from real data"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/stat_cor.html">stat_cor</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"pearson"</span>, label.x <span class="op">=</span> <span class="op">-</span><span class="fl">1.4</span>, label.y <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-27-1.png" width="672">
:::</div>
<p>To study the risk for overintegration, let’s imagine that there were a third
treatment group with relatively fewer samples. This is the type of group that a
correction method might accidentally blend in with the rest, if it’s too
aggressive. We’ve defined the imaginary experiment using the data.frame below.
The <code>treatment</code> level <code>1.8</code> is the new one. We’ve supposed there are between 1 -
3 technical replicates (<code>extraction</code>) for each biological sample (<code>sample</code>), and
the batch dates are the same as before.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">imaginary_design</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">imaginary_design</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    extraction        batch      treatment           rep           sample   
##  Min.   :1    09/04/2015:36   Min.   :0.0000   Min.   :1.00   1      :  2  
##  1st Qu.:1    14/04/2016:36   1st Qu.:0.0000   1st Qu.:1.75   2      :  2  
##  Median :2    01/07/2016:36   Median :1.0000   Median :2.50   3      :  2  
##  Mean   :2    14/11/2016:36   Mean   :0.7167   Mean   :2.75   4      :  2  
##  3rd Qu.:3    21/09/2017:36   3rd Qu.:1.0000   3rd Qu.:4.00   5      :  2  
##  Max.   :3                    Max.   :1.8000   Max.   :5.00   6      :  2  
##                                                               (Other):168</code></pre>
<p>We can simulate from the new design and look at how different this new treatment
group seems from the others. It’s a subtle effect, definitely smaller than the
batch effect, but also separate enough that we should be able to preserve it.</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">anaerobic_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">simulator</span>, new_data <span class="op">=</span> <span class="va">imaginary_design</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">[[</span><span class="st">"sim"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">pca_batch</span><span class="op">(</span><span class="va">anaerobic_sim</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="benchmarking" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Benchmarking<a class="anchor" aria-label="anchor" href="#benchmarking"><i class="fas fa-link"></i></a>
</h2>
<p>We’ve defined a <code>batch_correct</code> wrapper function that implements either the
RUV-III or ComBat batch effect correction methods. Their outputs are contrasted
in the PCAs below. It looks like ComBat might be somewhat too aggressive,
causing the <code>1</code> and <code>1.8</code> treatment groups to substantially overlap, while RUV
is a bit more conservative, keeping the treatment groups nicely separate. As an
aside, we note that this conclusion can depend on the number of replicates and
total number of samples available. We’ve included the code for generating the
<code>imaginary_design</code> data.frame in <a href="https://github.com/krisrs1128/intro-to-simulation/blob/10fa498aea952684204b2f15c387a7983c30626d/MIGsim/vignettes/process-integration.Rmd#L76">a vignette</a>
for the <code>MIGsim</code> package. Can you find settings that lead either method astray?</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span><span class="op">[[</span><span class="st">"ruv"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">pca_batch</span><span class="op">(</span><span class="fu">batch_correct</span><span class="op">(</span><span class="va">anaerobic_sim</span>, <span class="st">"ruv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">[[</span><span class="st">"combat"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">pca_batch</span><span class="op">(</span><span class="fu">batch_correct</span><span class="op">(</span><span class="va">anaerobic_sim</span>, <span class="st">"combat"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="simulation_for_microbiome_files/figure-html/batch-correction-vis-1.png" width="672"></div>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_errors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lda.html">lda</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">~</span> <span class="va">PC1</span> <span class="op">+</span> <span class="va">PC2</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">$</span><span class="va">class</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">treatment</span>, <span class="va">y_hat</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/map.html">map</a></span><span class="op">(</span><span class="va">p</span>, <span class="op">~</span> <span class="fu">prediction_errors</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## $sim
##      y_hat
##        0  1 1.8
##   0   62 13   0
##   1   15 56   4
##   1.8  1 14  15
## 
## $ruv
##      y_hat
##        0  1 1.8
##   0   70  5   0
##   1    2 67   6
##   1.8  0  8  22
## 
## $combat
##      y_hat
##        0  1 1.8
##   0   65 10   0
##   1   12 59   4
##   1.8  1 12  17</code></pre>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## R version 4.4.1 Patched (2024-08-21 r87049)
## Platform: aarch64-apple-darwin20
## Running under: macOS Sonoma 14.5
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## time zone: America/Chicago
## tzcode source: internal
## 
## attached base packages:
##  [1] splines   parallel  stats4    stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] lubridate_1.9.3                 readr_2.1.5                     tidyverse_2.0.0                 doRNG_1.8.6                     rngtools_1.5.2                 
##  [6] foreach_1.5.2                   ggpubr_0.6.0                    ggrepel_0.9.6                   edgeR_4.3.16                    limma_3.61.10                  
## [11] ANCOMBC_2.7.0                   stringr_1.5.1                   ks_1.14.3                       tidySummarizedExperiment_1.15.1 ttservice_0.4.1                
## [16] SimBench_0.99.1                 wesanderson_0.3.7               mia_1.13.36                     MultiAssayExperiment_1.31.5     TreeSummarizedExperiment_2.13.0
## [21] Biostrings_2.73.1               XVector_0.45.0                  SingleCellExperiment_1.27.2     gamlss_5.4-22                   nlme_3.1-166                   
## [26] gamlss.dist_6.1-1               gamlss.data_6.0-6               scDesigner_0.0.0.9000           purrr_1.0.2                     MIGsim_0.0.0.9000              
## [31] tidyr_1.3.1                     tibble_3.2.1                    scico_1.5.0                     pwr_1.3-0                       patchwork_1.3.0                
## [36] mutoss_0.1-13                   mvtnorm_1.3-1                   mixOmics_6.29.0                 lattice_0.22-6                  MASS_7.3-61                    
## [41] glue_1.8.0                      ggplot2_3.5.1                   ggdist_3.3.2                    gamboostLSS_2.0-7               mboost_2.9-11                  
## [46] stabs_0.6-4                     forcats_1.0.0                   dplyr_1.1.4                     SummarizedExperiment_1.35.1     Biobase_2.65.1                 
## [51] GenomicRanges_1.57.1            GenomeInfoDb_1.41.1             IRanges_2.39.2                  S4Vectors_0.43.2                BiocGenerics_0.51.1            
## [56] MatrixGenerics_1.17.0           matrixStats_1.4.1               SpiecEasi_1.1.3                 CovTools_0.5.4                 
## 
## loaded via a namespace (and not attached):
##   [1] igraph_2.0.3                ica_1.0-3                   plotly_4.10.4               Formula_1.2-5               scater_1.33.4               zlibbioc_1.51.1            
##   [7] tidyselect_1.2.1            bit_4.5.0                   doParallel_1.0.17           pspline_1.0-20              blob_1.2.4                  S4Arrays_1.5.8             
##  [13] png_0.1-8                   plotrix_3.8-4               cli_3.6.3                   CVXR_1.0-14                 pulsar_0.3.11               arrayhelpers_1.1-0         
##  [19] multtest_2.61.0             goftest_1.2-3               textshaping_0.4.0           bluster_1.15.1              BiocNeighbors_1.99.1        uwot_0.2.2                 
##  [25] mime_0.12                   evaluate_1.0.0              tidytree_0.4.6              leiden_0.4.3.1              stringi_1.8.4               backports_1.5.0            
##  [31] XML_3.99-0.17               lmerTest_3.1-3              Exact_3.3                   gsl_2.1-8                   httpuv_1.6.15               AnnotationDbi_1.67.0       
##  [37] magrittr_2.0.3              mclust_6.1.1                ADGofTest_0.3               pcaPP_2.0-5                 rootSolve_1.8.2.4           sctransform_0.4.1          
##  [43] lpSolve_5.6.21              ggbeeswarm_0.7.2            DBI_1.2.3                   genefilter_1.87.0           jquerylib_0.1.4             withr_3.0.1                
##  [49] corpcor_1.6.10              systemfonts_1.1.0           class_7.3-22                lmtest_0.9-40               sva_3.53.0                  compositions_2.0-8         
##  [55] htmlwidgets_1.6.4           fs_1.6.4                    labeling_0.4.3              SparseArray_1.5.38          DEoptimR_1.1-3              cellranger_1.1.0           
##  [61] DESeq2_1.45.3               tidybayes_3.0.7             extrafont_0.19              annotate_1.83.0             lmom_3.0                    flare_1.7.0.1              
##  [67] reticulate_1.39.0           minpack.lm_1.2-4            geigen_2.3                  zoo_1.8-12                  knitr_1.48                  nnls_1.5                   
##  [73] UCSC.utils_1.1.0            svUnit_1.0.6                SHT_0.1.8                   timechange_0.3.0            decontam_1.25.0             fansi_1.0.6                
##  [79] grid_4.4.1                  rhdf5_2.49.0                data.table_1.16.0           ruv_0.9.7.1                 vegan_2.6-8                 RSpectra_0.16-2            
##  [85] irlba_2.3.5.1               extrafontdb_1.0             DescTools_0.99.56           ellipsis_0.3.2              fastDummies_1.7.4           ade4_1.7-22                
##  [91] lazyeval_0.2.2              yaml_2.3.10                 survival_3.7-0              scattermore_1.2             crayon_1.5.3                mediation_4.5.0            
##  [97] tensorA_0.36.2.1            phyloseq_1.49.0             RcppAnnoy_0.0.22            RColorBrewer_1.1-3          progressr_0.14.0            later_1.3.2                
## [103] ggridges_0.5.6              codetools_0.2-20            base64enc_0.1-3             Seurat_5.1.0                KEGGREST_1.45.1             Rtsne_0.17                 
## [109] shape_1.4.6.1               randtoolbox_2.0.4           foreign_0.8-87              pkgconfig_2.0.3             xml2_1.3.6                  spatstat.univar_3.0-1      
## [115] downlit_0.4.4               scatterplot3d_0.3-44        spatstat.sparse_3.1-0       ape_5.8                     viridisLite_0.4.2           xtable_1.8-4               
## [121] highr_0.11                  car_3.1-2                   fastcluster_1.2.6           plyr_1.8.9                  httr_1.4.7                  rbibutils_2.2.16           
## [127] tools_4.4.1                 globals_0.16.3              SeuratObject_5.0.2          kde1d_1.0.7                 beeswarm_0.4.0              htmlTable_2.4.3            
## [133] broom_1.0.6                 checkmate_2.3.2             rgl_1.3.1                   assertthat_0.2.1            lme4_1.1-35.5               rngWELL_0.10-9             
## [139] digest_0.6.37               bayesm_3.1-6                permute_0.9-7               numDeriv_2016.8-1.1         bookdown_0.40               Matrix_1.7-0               
## [145] tzdb_0.4.0                  farver_2.1.2                reshape2_1.4.4              yulab.utils_0.1.7           viridis_0.6.5               DirichletMultinomial_1.47.0
## [151] rpart_4.1.23                cachem_1.1.0                polyclip_1.10-7             WGCNA_1.73                  Hmisc_5.1-3                 generics_0.1.3             
## [157] dynamicTreeCut_1.63-1       parallelly_1.38.0           biomformat_1.33.0           statmod_1.5.0               impute_1.79.0               huge_1.3.5                 
## [163] ragg_1.3.3                  RcppHNSW_0.6.0              ScaledMatrix_1.13.0         carData_3.0-5               minqa_1.2.8                 pbapply_1.7-2              
## [169] glmnet_4.1-8                spam_2.10-0                 utf8_1.2.4                  gtools_3.9.5                shapes_1.2.7                readxl_1.4.3               
## [175] preprocessCore_1.67.0       inum_1.0-5                  ggsignif_0.6.4              energy_1.7-12               gridExtra_2.3               shiny_1.9.1                
## [181] GenomeInfoDbData_1.2.12     rhdf5filters_1.17.0         memoise_2.0.1               rmarkdown_2.28              scales_1.3.0                gld_2.6.6                  
## [187] stabledist_0.7-2            partykit_1.2-22             svglite_2.1.3               future_1.34.0               RANN_2.6.2                  spatstat.data_3.1-2        
## [193] rstudioapi_0.16.0           cluster_2.1.6               spatstat.utils_3.1-0        hms_1.1.3                   fitdistrplus_1.2-1          munsell_0.5.1              
## [199] cowplot_1.1.3               colorspace_2.1-1            ellipse_0.5.0               rlang_1.1.4                 quadprog_1.5-8              copula_1.1-4               
## [205] DelayedMatrixStats_1.27.3   sparseMatrixStats_1.17.2    dotCall64_1.1-1             scuttle_1.15.4              mgcv_1.9-1                  xfun_0.47                  
## [211] coda_0.19-4.1               e1071_1.7-16                TH.data_1.1-2               posterior_1.6.0             iterators_1.0.14            rARPACK_0.11-0             
## [217] abind_1.4-8                 libcoin_1.0-10              treeio_1.29.1               gmp_0.7-5                   Rhdf5lib_1.27.0             DECIPHER_3.1.4             
## [223] Rdpack_2.6.1                promises_1.3.0              RSQLite_2.3.7               sandwich_3.1-1              proxy_0.4-27                DelayedArray_0.31.11       
## [229] Rmpfr_0.9-5                 GO.db_3.20.0                compiler_4.4.1              prettyunits_1.2.0           boot_1.3-31                 distributional_0.5.0       
## [235] beachmat_2.21.6             rbiom_1.0.3                 listenv_0.9.1               Rcpp_1.0.13                 Rttf2pt1_1.3.12             BiocSingular_1.21.4        
## [241] tensor_1.5                  progress_1.2.3              BiocParallel_1.39.0         insight_0.20.5              spatstat.random_3.3-2       R6_2.5.1                   
## [247] fastmap_1.2.0               multcomp_1.4-26             rstatix_0.7.2               vipor_0.4.7                 ROCR_1.0-11                 rsvd_1.0.5                 
## [253] nnet_7.3-19                 gtable_0.3.5                KernSmooth_2.23-24          miniUI_0.1.1.1              deldir_2.0-4                htmltools_0.5.8.1          
## [259] ggthemes_5.1.0              RcppParallel_5.1.9          bit64_4.5.2                 spatstat.explore_3.3-2      lifecycle_1.0.4             nloptr_2.1.1               
## [265] sass_0.4.9                  vctrs_0.6.5                 robustbase_0.99-4           VGAM_1.1-12                 slam_0.1-53                 spatstat.geom_3.3-3        
## [271] sp_2.1-4                    future.apply_1.11.2         pracma_2.4.4                rvinecopulib_0.6.3.1.1      bslib_0.8.0                 pillar_1.9.0               
## [277] locfit_1.5-9.10             jsonlite_1.8.9              expm_1.0-0</code></pre>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="microbiome-networks.html"><span class="header-section-number">4</span> Microbiome Networks</a></div>
<div class="next"><a href="vertical-integration.html"><span class="header-section-number">6</span> Vertical Integration</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#batch-effect-correction"><span class="header-section-number">5</span> Batch Effect Correction</a></li>
<li><a class="nav-link" href="#anaerobic-digestion-data"><span class="header-section-number">5.1</span> Anaerobic Digestion Data</a></li>
<li><a class="nav-link" href="#simulation-design"><span class="header-section-number">5.2</span> Simulation Design</a></li>
<li><a class="nav-link" href="#benchmarking"><span class="header-section-number">5.3</span> Benchmarking</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Simulation for Microbiome Analysis</strong>" was written by Kris Sankaran, Saritha Kodikara, Jingyi Jessica Li, and Kim-Anh Lê Cao. It was last built on 2024-10-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
