<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 6 Vertical Integration | Simulation for Microbiome Analysis</title>
<meta name="author" content="Kris Sankaran, Saritha Kodikara, Jingyi Jessica Li, and Kim-Anh Lê Cao">
<meta name="description" content="In horizontal integration, we have many datasets, all with the same features. They only differ because they were gathered at different times. In contrast, for vertical integration, we instead have...">
<meta name="generator" content="bookdown 0.40 with bs4_book()">
<meta property="og:title" content="Chapter 6 Vertical Integration | Simulation for Microbiome Analysis">
<meta property="og:type" content="book">
<meta property="og:url" content="https://krisrs1128.github.io/microbiome-simulation/vertical-integration.html">
<meta property="og:description" content="In horizontal integration, we have many datasets, all with the same features. They only differ because they were gathered at different times. In contrast, for vertical integration, we instead have...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 6 Vertical Integration | Simulation for Microbiome Analysis">
<meta name="twitter:description" content="In horizontal integration, we have many datasets, all with the same features. They only differ because they were gathered at different times. In contrast, for vertical integration, we instead have...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Simulation for Microbiome Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="simulating-differential-abundance.html"><span class="header-section-number">2</span> Simulating Differential Abundance</a></li>
<li><a class="" href="multivariate-power-analysis.html"><span class="header-section-number">3</span> Multivariate Power Analysis</a></li>
<li><a class="" href="microbiome-networks.html"><span class="header-section-number">4</span> Microbiome Networks</a></li>
<li><a class="" href="batch-effect-correction.html"><span class="header-section-number">5</span> Batch Effect Correction</a></li>
<li><a class="active" href="vertical-integration.html"><span class="header-section-number">6</span> Vertical Integration</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="vertical-integration" class="section level1" number="6">
<h1>
<span class="header-section-number">6</span> Vertical Integration<a class="anchor" aria-label="anchor" href="#vertical-integration"><i class="fas fa-link"></i></a>
</h1>
<p>In horizontal integration, we have many datasets, all with the same features.
They only differ because they were gathered at different times. In contrast, for
vertical integration, we instead have many datasets all with the same <em>samples</em>.
They differ because they measure different aspects of those samples. Our goal in
this situation is not to remove differences across datasets, like it was in
horizontal integration, but instead to clarify the relationships across sources.</p>
<p>One important question that often arises in vertical integration is – are the
data even alignable? That is, in our effort to look for relationships across
datasets, we might accidentally miss out on interesting variation that exists
within the individual assays. If the technologies are measuring very different
things, we might be better off simply analyzing the data separately. To help us
gauge which setting we might be in, we can simulate data where we know that we
shouldn’t align the sources. If our integration methods are giving similar
outputs as they give on this simulated data, then we should be more cautious.</p>
<p>There are a few ways in which a dataset might not be ``alignable.’’ The most
general reason is that there may be no latent sources of variation in common
between the sources. A simpler reason is that something that influenced one
assay substantially (e.g., disease state) might not influence the other by much.
Let’s see how an integration method might work in this setting.</p>
<div id="icu-dataset" class="section level2" number="6.1">
<h2>
<span class="header-section-number">6.1</span> ICU Dataset<a class="anchor" aria-label="anchor" href="#icu-dataset"><i class="fas fa-link"></i></a>
</h2>
<p>We’ll work with the ICU sepsis dataset previously studied by <a href="https://doi.org/10.1128/mSystems.01148-20">Haak et al.
(2021)</a> and documented within a
<a href="https://raw.githack.com/bioFAM/MOFA2_tutorials/master/R_tutorials/microbiome_vignette.html#train-mofa-model">vignette</a>
for the MOFA package. The three datasets here are 16S bacterial, ITS fungal, and
Virome assays, all applied to different healthy and sepsis patient populations.
Moreover, some participants were on a course of antibiotics while others were
not. The question is how either sepsis, antibiotics, or their interaction
affects the microbiome viewed through these three assays. The data are printed
below, they have already been filtered and CLR transformed following the MOFA
vignette.</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">icu</span><span class="op">)</span></span>
<span><span class="va">icu</span></span></code></pre></div>
<pre><code>## $Bacteria
## class: SummarizedExperiment 
## dim: 180 57 
## metadata(0):
## assays(1): clr
## rownames(180): Acidaminococcus Actinomyces ... Veillonellaceae Weissella
## rowData names(0):
## colnames(57): TKI_F1 TKI_F10 ... TKI_F8 TKI_F9
## colData names(16): Age Sexs ... Propionate Butyrate
## 
## $Fungi
## class: SummarizedExperiment 
## dim: 18 57 
## metadata(0):
## assays(1): clr
## rownames(18): Agaricus Aspergillus ... Sclerotiniaceae Vishniacozyma
## rowData names(0):
## colnames(57): TKI_F1 TKI_F10 ... TKI_F8 TKI_F9
## colData names(16): Age Sexs ... Propionate Butyrate
## 
## $Viruses
## class: SummarizedExperiment 
## dim: 42 57 
## metadata(0):
## assays(1): clr
## rownames(42): Acidovorax phage Acinetobacter phage ... Streptomyces phage Vibrio phage
## rowData names(0):
## colnames(57): TKI_F1 TKI_F10 ... TKI_F8 TKI_F9
## colData names(16): Age Sexs ... Propionate Butyrate</code></pre>
<p>We can simultaneously analyze these data sources using block sPLS-DA. This is
the multi-assay version of the analysis that we saw in the previous session.
<code>exper_splsda</code> is a very light wrapper of a mixOmics function call, which you
can read
<a href="https://github.com/krisrs1128/intro-to-simulation/blob/9f842ef52fdbe9a137833531147ceb3bc1f7ae81/MIGsim/R/vertical_integration.R#L3">here</a>.
The output plot below shows that each assay differs across groups, and this is
quantitatively summarized by the high estimated weights between each category
and the estimated PLS directions.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">exper_splsda</span><span class="op">(</span><span class="va">icu</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-28-1.png" width="672"></div>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
<pre><code>##              comp1     comp2
## Bacteria 0.8580402 0.8191458
## Fungi    0.6513668 0.4845247
## Viruses  0.6118091 0.8047067</code></pre>
</div>
<div id="interlude-using-map" class="section level2" number="6.2">
<h2>
<span class="header-section-number">6.2</span> Interlude: Using map<a class="anchor" aria-label="anchor" href="#interlude-using-map"><i class="fas fa-link"></i></a>
</h2>
<p>In the examples below, we’ll find it helpful to use the function <code>map</code> in the
purrr package. This function gives a one-line replacement for simple for-loops;
it is analogous to list comprehensions in python. It can be useful many places
besides the topic of this tutorial. For example, if we want to convert the
vector <code>c(1, 2, 3)</code> into <code>c(1, 4, 9)</code>, we can use this map:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/map.html">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">~</span> <span class="va">.</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 4
## 
## [[3]]
## [1] 9</code></pre>
<p>The <code>~</code> notation is shorthand for defining a function, and the <code>.</code> represents
the current vector element. More generally, we can apply map to lists. This
line will update the list so that 1 is added to each element.</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">2</span>, c <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code>## $a
## [1] 2
## 
## $b
## [1] 3
## 
## $c
## [1] 4</code></pre>
<p><strong>Exercise</strong>: To test your understanding, can you write a map that computes the
*mean for each
vector in the list <code>x</code> below? What about the mean of the 10 smallest elements?</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<button onclick="myFunction('q-map')">
Show solution
</button>
<div id="q-map" style="display:none">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/map.html">map</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<pre><code>## $a
## [1] 0.1177328
## 
## $b
## [1] 1.128995</code></pre>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/map.html">map</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## $a
## [1] -1.920247
## 
## $b
## [1] -0.8639795</code></pre>
</div>
</div>
<div id="simulation-question" class="section level2" number="6.3">
<h2>
<span class="header-section-number">6.3</span> Simulation Question<a class="anchor" aria-label="anchor" href="#simulation-question"><i class="fas fa-link"></i></a>
</h2>
<p>How would the output have looked if 16S community composition had not been
related to disease or antibiotics groups? Since integrative analysis prioritizes
similarities across sources, we expect this to mask some of the real differences
in the fungal and virus data as well. We can use simulation to gauge the extent
of this masking.</p>
<p>Our first step is to train a simulator. We’re just learning four different
setes of parameters for each of the four observed groups. This is not as nuanced
as learning separate effects for sepsis and antibiotics, but it will be enough
for illustration. We have used <code>map</code> to estimate a simulator for each assay in
the <code>icu</code> list.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/map.html">map</a></span><span class="op">(</span></span>
<span>  <span class="va">icu</span>,</span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/setup_simulator.html">setup_simulator</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span><span class="va">Category</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gamboostLSS/man/families.html">GaussianLSS</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">estimate</span><span class="op">(</span>nu <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>So far, we haven’t tried removing any relationships present in the 16S assay,
and indeed our integrative analysis output on the simulated data looks
comparable to that from the original study.</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">icu_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/join_copula.html">join_copula</a></span><span class="op">(</span><span class="va">simulator</span>, <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/copula_adaptive.html">copula_adaptive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/split_assays.html">split_assays</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_sim</span> <span class="op">&lt;-</span> <span class="fu">exper_splsda</span><span class="op">(</span><span class="va">icu_sim</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">fit_sim</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-34-1.png" width="672"></div>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
<pre><code>##              comp1     comp2
## Bacteria 0.8580402 0.8191458
## Fungi    0.6513668 0.4845247
## Viruses  0.6118091 0.8047067</code></pre>
<p><strong>Exercise</strong>: Modify the simulator above so that the 16S group no longer depends
on disease cateogry. This will allow us to study how the integrative analysis
output changes when the data are not alignable.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">null_simulator</span> <span class="op">&lt;-</span> <span class="va">simulator</span></span>
<span><span class="co"># fill this in</span></span>
<span><span class="co"># null_simulator[[1]] &lt;- ???</span></span></code></pre></div>
<p><strong>Solution</strong>: We need to define a new link that no longer depends on <code>Category</code>. One solution
is to modify the existing simulator in place using <code>mutate</code>.</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">null_simulator</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">180</span>, link <span class="op">=</span> <span class="op">~</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">estimate</span><span class="op">(</span>nu <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<p>Since we are modifying all taxa, a simpler solution is to just define a
new simulator from scratch.</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">null_simulator</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/setup_simulator.html">setup_simulator</a></span><span class="op">(</span><span class="va">icu</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="op">~</span><span class="fl">1</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gamboostLSS/man/families.html">GaussianLSS</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">estimate</span><span class="op">(</span>nu <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="simulation-results" class="section level2" number="6.4">
<h2>
<span class="header-section-number">6.4</span> Simulation Results<a class="anchor" aria-label="anchor" href="#simulation-results"><i class="fas fa-link"></i></a>
</h2>
<p>We can rerun the integrative analysis using the modified simulator. Somewhat
surprisingly, the disease association in the bacteria group hasn’t been erased.
This is an artifact of the integration. The other assays have associations with
disease group, and since the method encourages outputs across tables to be
consistent with one another, we have artificially introduced some structure into
the bacteria visualization (even if it is quite weak.) Nonetheless, we still
observe a large dropoff in weight for the bacterial table. Further, there seems
to be a minor deterioration in the group separations for the fungal and virus
communities, and the component weights are higher when we work with only the
fungal and virus assays. Altogether, this suggests that we may want to check
table-level associations with the response variable, especially if any of the
integration outputs are ambiguous. In this case, we might be able to increase
power by focusing only on class-associated assays. Nonetheless, the block
sPLS-DA also seems relatively robust – considering the dramatic change in the
microbiome table, the output for the remaining tables still surfaces interesting
relationships.</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">icu_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/join_copula.html">join_copula</a></span><span class="op">(</span><span class="va">null_simulator</span>, <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/copula_adaptive.html">copula_adaptive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/split_assays.html">split_assays</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fit_null</span> <span class="op">&lt;-</span> <span class="fu">exper_splsda</span><span class="op">(</span><span class="va">icu_sim</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-38-1.png" width="672"></div>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_null</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
<pre><code>##              comp1     comp2
## Bacteria 0.6658170 0.6571177
## Fungi    0.7479665 0.6797712
## Viruses  0.7015960 0.7929047</code></pre>
<p><img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-39-1.png" width="672"><img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-39-2.png" width="672"><img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-39-3.png" width="672"><img src="simulation_for_microbiome_files/figure-html/unnamed-chunk-39-4.png" width="672"></p>
</div>
<div id="alignability" class="section level2" number="6.5">
<h2>
<span class="header-section-number">6.5</span> Alignability<a class="anchor" aria-label="anchor" href="#alignability"><i class="fas fa-link"></i></a>
</h2>
<p>How do the canonical correlations compare between the real data and a reference
null? First, we can compute the CCA canonical correlations using the real
Bacteria and Virus data.</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">merged</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/join_copula.html">join_copula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/copula_adaptive.html">copula_adaptive</a></span><span class="op">(</span>thr <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">merged</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/map.html">map</a></span><span class="op">(</span><span class="va">icu</span>, <span class="va">rownames</span><span class="op">)</span></span>
<span><span class="va">cca_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/rcc.html">rcc</a></span><span class="op">(</span><span class="va">xy</span><span class="op">[</span>, <span class="va">ix</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">]</span>, <span class="va">xy</span><span class="op">[</span>, <span class="va">ix</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"shrinkage"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we define a reference null and compute canonical correlations on ten
replicates from this null. To define the reference null, we zero out any
correlations across tables. We then draw 100 samples from the resulting
distribution and compute canonical correlations for each.</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rho_null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/copula_parameters.html">copula_parameters</a></span><span class="op">(</span><span class="va">merged</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">rho_null</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">xy</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">xy</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rho_null</span><span class="op">[</span><span class="va">ix</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">ix</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">rho_null</span><span class="op">[</span><span class="va">ix</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, <span class="va">ix</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">null_cancor</span> <span class="op">&lt;-</span> <span class="va">merged</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/scDesigner/man/mutate_correlation.html">mutate_correlation</a></span><span class="op">(</span><span class="va">rho_null</span><span class="op">)</span></span>
<span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">cancors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">b</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">xy_null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">null_cancor</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html">assay</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cancors</span><span class="op">[[</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"sim_{b}"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/rcc.html">rcc</a></span><span class="op">(</span><span class="va">xy_null</span><span class="op">[</span>, <span class="va">ix</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">]</span>, <span class="va">xy_null</span><span class="op">[</span>, <span class="va">ix</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"shrinkage"</span><span class="op">)</span><span class="op">$</span><span class="va">cor</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To help with later visualization, we combine both the real and reference
canonical correlations into a tidy data.frame. These are visualized in a hidden
chunk below – if you want to see the source code, you can review it
<a href="https://github.com/krisrs1128/microbiome-simulation/blob/main/book/04-integration.Rmd">here</a>.</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cancors</span><span class="op">[[</span><span class="st">"true"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cca_result</span><span class="op">$</span><span class="va">cor</span></span>
<span><span class="va">contrast_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">cancors</span>, .id <span class="op">=</span> <span class="st">"rep"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">rep</span>, names_to <span class="op">=</span> <span class="st">"loading"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"true"</span>, <span class="va">rep</span><span class="op">)</span>,</span>
<span>    loading <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">loading</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">contrast_data</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   rep   loading value source
##   &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt; &lt;lgl&gt; 
## 1 sim_1       1 0.913 FALSE 
## 2 sim_1       2 0.880 FALSE 
## 3 sim_1       3 0.848 FALSE 
## 4 sim_1       4 0.826 FALSE 
## 5 sim_1       5 0.815 FALSE 
## 6 sim_1       6 0.797 FALSE</code></pre>
<div class="inline-figure"><img src="simulation_for_microbiome_files/figure-html/contrast-vis-1.png" width="672"></div>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## R version 4.4.0 (2024-04-24)
## Platform: aarch64-apple-darwin20
## Running under: macOS Ventura 13.4
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## time zone: America/Chicago
## tzcode source: internal
## 
## attached base packages:
##  [1] splines   parallel  stats4    stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] TreeSummarizedExperiment_2.12.0 Biostrings_2.72.1               XVector_0.44.0                  SingleCellExperiment_1.26.0     scDesigner_0.0.0.9000           purrr_1.0.2                    
##  [7] MIGsim_0.0.0.9000               tidyr_1.3.1                     tibble_3.2.1                    scico_1.5.0                     pwr_1.3-0                       patchwork_1.2.0                
## [13] mixOmics_6.28.0                 lattice_0.22-6                  MASS_7.3-60.2                   glue_1.7.0                      ggplot2_3.5.1                   ggdist_3.3.2                   
## [19] gamboostLSS_2.0-7               mboost_2.9-10                   stabs_0.6-4                     forcats_1.0.0                   dplyr_1.1.4                     SummarizedExperiment_1.34.0    
## [25] Biobase_2.64.0                  GenomicRanges_1.56.0            GenomeInfoDb_1.40.0             IRanges_2.38.0                  S4Vectors_0.42.0                BiocGenerics_0.50.0            
## [31] MatrixGenerics_1.16.0           matrixStats_1.3.0               SpiecEasi_1.1.3                 CovTools_0.5.4                 
## 
## loaded via a namespace (and not attached):
##   [1] minpack.lm_1.2-4            XML_3.99-0.16.1             rpart_4.1.23                lifecycle_1.0.4             Rdpack_2.6                  edgeR_4.2.0                 doParallel_1.0.17          
##   [8] MultiAssayExperiment_1.30.2 insight_0.20.1              magrittr_2.0.3              limma_3.60.2                sass_0.4.9                  rmarkdown_2.27              jquerylib_0.1.4            
##  [15] yaml_2.3.8                  DBI_1.2.3                   RColorBrewer_1.1-3          ADGofTest_0.3               abind_1.4-5                 zlibbioc_1.50.0             expm_0.999-9               
##  [22] quadprog_1.5-8              pspline_1.0-20              kde1d_1.0.7                 rgl_1.3.1                   yulab.utils_0.1.4           pracma_2.4.4                sva_3.50.0                 
##  [29] GenomeInfoDbData_1.2.12     ggrepel_0.9.5               tidytree_0.4.6              genefilter_1.86.0           ellipse_0.5.0               RSpectra_0.16-1             annotate_1.82.0            
##  [36] svglite_2.1.3               codetools_0.2-20            DelayedArray_0.30.1         shapes_1.2.7                tidyselect_1.2.1            shape_1.4.6.1               UCSC.utils_1.0.0           
##  [43] farver_2.1.2                randtoolbox_2.0.4           base64enc_0.1-3             jsonlite_1.8.8              Formula_1.2-5               survival_3.7-0              iterators_1.0.14           
##  [50] systemfonts_1.1.0           foreach_1.5.2               tools_4.4.0                 progress_1.2.3              treeio_1.28.0               ragg_1.3.2                  Rcpp_1.0.12                
##  [57] rARPACK_0.11-0              BiocBaseUtils_1.6.0         gridExtra_2.3               SparseArray_1.4.8           mgcv_1.9-1                  xfun_0.44                   distributional_0.4.0       
##  [64] withr_3.0.0                 numDeriv_2016.8-1.1         fastmap_1.2.0               fansi_1.0.6                 digest_0.6.35               R6_2.5.1                    textshaping_0.4.0          
##  [71] colorspace_2.1-0            RSQLite_2.3.7               inum_1.0-5                  copula_1.1-3                flare_1.7.0.1               utf8_1.2.4                  generics_0.1.3             
##  [78] corpcor_1.6.10              prettyunits_1.2.0           pulsar_0.3.11               httr_1.4.7                  htmlwidgets_1.6.4           S4Arrays_1.4.1              scatterplot3d_0.3-44       
##  [85] rngWELL_0.10-9              pkgconfig_2.0.3             geigen_2.3                  gtable_0.3.5                blob_1.2.4                  pcaPP_2.0-4                 htmltools_0.5.8.1          
##  [92] bookdown_0.39.1             ruv_0.9.7.1                 scales_1.3.0                SHT_0.1.8                   png_0.1-8                   knitr_1.47                  rstudioapi_0.16.0          
##  [99] reshape2_1.4.4              nlme_3.1-164                cachem_1.1.0                stringr_1.5.1               libcoin_1.0-10              AnnotationDbi_1.66.0        pillar_1.9.0               
## [106] grid_4.4.0                  vctrs_0.6.5                 VGAM_1.1-11                 huge_1.3.5                  xtable_1.8-4                gamlss.dist_6.1-1           evaluate_0.23              
## [113] mvtnorm_1.2-5               cli_3.6.3                   locfit_1.5-9.9              compiler_4.4.0              rlang_1.1.4                 crayon_1.5.3                labeling_0.4.3             
## [120] plyr_1.8.9                  fs_1.6.4                    stringi_1.8.4               BiocParallel_1.38.0         nnls_1.5                    assertthat_0.2.1            rvinecopulib_0.6.3.1.1     
## [127] munsell_0.5.1               gsl_2.1-8                   lazyeval_0.2.2              glmnet_4.1-8                Matrix_1.7-0                hms_1.1.3                   stabledist_0.7-1           
## [134] bit64_4.0.5                 KEGGREST_1.44.0             statmod_1.5.0               highr_0.11                  rbibutils_2.2.16            partykit_1.2-20             igraph_2.0.3               
## [141] memoise_2.0.1               bslib_0.7.0.9000            bit_4.0.5                   ape_5.8</code></pre>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="batch-effect-correction.html"><span class="header-section-number">5</span> Batch Effect Correction</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#vertical-integration"><span class="header-section-number">6</span> Vertical Integration</a></li>
<li><a class="nav-link" href="#icu-dataset"><span class="header-section-number">6.1</span> ICU Dataset</a></li>
<li><a class="nav-link" href="#interlude-using-map"><span class="header-section-number">6.2</span> Interlude: Using map</a></li>
<li><a class="nav-link" href="#simulation-question"><span class="header-section-number">6.3</span> Simulation Question</a></li>
<li><a class="nav-link" href="#simulation-results"><span class="header-section-number">6.4</span> Simulation Results</a></li>
<li><a class="nav-link" href="#alignability"><span class="header-section-number">6.5</span> Alignability</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Simulation for Microbiome Analysis</strong>" was written by Kris Sankaran, Saritha Kodikara, Jingyi Jessica Li, and Kim-Anh Lê Cao. It was last built on 2024-09-08.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
